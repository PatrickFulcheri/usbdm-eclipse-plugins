<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USBDM: dma-spi-example.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USBDM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">dma-spi-example.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> ============================================================================</span></div><div class="line"><span class="comment"> * @file    dma-spi-example.cpp (180.ARM_Peripherals/Snippets)</span></div><div class="line"><span class="comment"> * @brief   DMA example using SPI</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  Created on: 10/1/2016</span></div><div class="line"><span class="comment"> *      Author: podonoghue</span></div><div class="line"><span class="comment"> ============================================================================</span></div><div class="line"><span class="comment"> */</span><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * This example uses DMA to transfer data from a buffer to the SPI for transmission.</span></div><div class="line"><span class="comment"> * At the same time another DMA channel is used to transfer receive data from the SPI to a buffer.</span></div><div class="line"><span class="comment"> * The transmission is not continuous but may be restarted without setting up the TCD again:</span></div><div class="line"><span class="comment"> * - Clears the DREQ on transfer complete</span></div><div class="line"><span class="comment"> * - Arranging SLAST/DLAST to return the transfer addresses to starting value after each major-loop.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="system_8h.html">system.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="derivative_8h.html">derivative.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hardware_8h.html">hardware.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="dma_8h.html">dma.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="spi_8h.html">spi.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_u_s_b_d_m.html">USBDM</a>;</div><div class="line"></div><div class="line"><span class="comment">// Connection - change as required</span></div><div class="line"><span class="keyword">using</span> Led         = <a name="_a0"></a><a class="code" href="class_u_s_b_d_m_1_1_gpio_c.html">GpioC&lt;3, ActiveLow&gt;</a>;  <span class="comment">// = PTA2 = D9 = Blue LED</span></div><div class="line"></div><div class="line"><span class="comment">// SPI to use</span></div><div class="line"><a name="_a1"></a><a class="code" href="class_u_s_b_d_m_1_1_spi_irq___t.html">Spi0</a> spi;</div><div class="line"></div><div class="line"><span class="comment">// DMA channel numbers</span></div><div class="line"><span class="keyword">static</span> constexpr <a class="code" href="group___d_m_a___group.html#gad0ee5634a54a477cfa6fd917791fb5bb">DmaChannelNum</a> DMA_TX_CHANNEL = <a name="a2"></a><a class="code" href="group___d_m_a___group.html#ggad0ee5634a54a477cfa6fd917791fb5bbade683904fdaefeee7a5f5531311776bf">DmaChannelNum_0</a>;</div><div class="line"><span class="keyword">static</span> constexpr <a class="code" href="group___d_m_a___group.html#gad0ee5634a54a477cfa6fd917791fb5bb">DmaChannelNum</a> DMA_RX_CHANNEL = <a name="a3"></a><a class="code" href="group___d_m_a___group.html#ggad0ee5634a54a477cfa6fd917791fb5bbaa4619a361fdcfe78fb3c784d5ae738f4">DmaChannelNum_1</a>;</div><div class="line"></div><div class="line"><span class="comment">// Used to indicate complete transfer</span></div><div class="line"><span class="keywordtype">bool</span> complete;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * DMA complete callback</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Sets flag to indicate sequence complete.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> dmaCallback() {</div><div class="line">   complete = <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> constexpr uint32_t PUSH_BASE =</div><div class="line">      <a name="a4"></a><a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(0)|</div><div class="line">      <a name="a5"></a><a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gadc43fdbca4e34579e7ede4ac104c7ae5">SPI_PUSHR_CTAS</a>(0)|</div><div class="line">      <a name="a6"></a><a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga91c3110a4dbb544395f48a657b22dabe">SPI_PUSHR_EOQ</a>(0)|</div><div class="line">      <a name="a7"></a><a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga4662cfbebbea26e0c427a9e4c310d9b2">SPI_PUSHR_CTCNT</a>(0)|</div><div class="line">      <a name="a8"></a><a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad551a287ffb207f5d78c2ac04d393a9b">SPI_PUSHR_PCS</a>(1&lt;&lt;0);</div><div class="line"></div><div class="line"><span class="keyword">const</span> uint32_t txBuffer[]= {</div><div class="line">      <a name="a9"></a><a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(1)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1)|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga4662cfbebbea26e0c427a9e4c310d9b2">SPI_PUSHR_CTCNT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(2)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(3)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(4)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(5)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(6)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(7)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(8)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(9)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(10)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(11)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(12)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(13)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(1),</div><div class="line">      <a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#gad19c7faf45531d7c7a6703a54ac2f69d">SPI_PUSHR_TXDATA</a>(14)|PUSH_BASE|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga7efcf8c8ad046b928c6aa218e9d63be7">SPI_PUSHR_CONT</a>(0)|<a class="code" href="group___s_p_i___register___masks___g_r_o_u_p.html#ga91c3110a4dbb544395f48a657b22dabe">SPI_PUSHR_EOQ</a>(0),</div><div class="line">};</div><div class="line"></div><div class="line">uint8_t rxBuffer[<span class="keyword">sizeof</span>(txBuffer)/4];</div><div class="line"><span class="keyword">const</span> uint8_t rxTestBuffer[<span class="keyword">sizeof</span>(txBuffer)/4] = {1,2,3,4,5,6,7,8,9,10,11,12,13,14};</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Configure DMA from Memory-to-UART</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> initDma() {</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * @verbatim</span></div><div class="line"><span class="comment">    * +------------------------------+            Simple DMA mode (MLNO = Minor Loop Mapping Disabled)</span></div><div class="line"><span class="comment">    * | Major Loop =                 |            ==================================================</span></div><div class="line"><span class="comment">    * |    CITER x Minor Loop        |</span></div><div class="line"><span class="comment">    * |                              |            Each DMA request triggers a minor-loop transfer sequence.</span></div><div class="line"><span class="comment">    * | +--------------------------+ |&lt;-DMA Req.  The minor loops are counted in the major-loop.</span></div><div class="line"><span class="comment">    * | | Minor Loop               | |</span></div><div class="line"><span class="comment">    * | | Each transfer            | |            The following are used during a minor loop:</span></div><div class="line"><span class="comment">    * | |   SADDR-&gt;DADDR           | |             - SADDR Source address</span></div><div class="line"><span class="comment">    * | |   SADDR += SOFF          | |             - SOFF  Adjustment applied to SADDR after each transfer</span></div><div class="line"><span class="comment">    * | |   DADDR += DOFF          | |             - DADDR Destination address</span></div><div class="line"><span class="comment">    * | | Total transfer is NBYTES | |             - DOFF  Adjustment applied to DADDR after each transfer</span></div><div class="line"><span class="comment">    * | +--------------------------+ |             - NBYTES Number of bytes to transfer</span></div><div class="line"><span class="comment">    * | +--------------------------+ |&lt;-DMA Req.   - Attributes</span></div><div class="line"><span class="comment">    * | | Minor Loop               | |               - ATTR_SSIZE, ATTR_DSIZE Source and destination transfer sizes</span></div><div class="line"><span class="comment">    * |..............................|               - ATTR_SMOD, ATTR_DMOD Modulo --TODO</span></div><div class="line"><span class="comment">    * | |                          | |</span></div><div class="line"><span class="comment">    * | +--------------------------+ |             The number of reads and writes done will depend on NBYTES, SSIZE and DSIZE</span></div><div class="line"><span class="comment">    * | +--------------------------+ |&lt;-DMA Req.   For example: NBYTES=12, SSIZE=16-bits, DSIZE=32-bits =&gt; 6 reads, 3 writes</span></div><div class="line"><span class="comment">    * | | Minor Loop               | |             NBYTES must be an even multiple of SSIZE and DSIZE in bytes.</span></div><div class="line"><span class="comment">    * | | Each transfer            | |</span></div><div class="line"><span class="comment">    * | |   SADDR-&gt;DADDR           | |            The following are used by the major loop</span></div><div class="line"><span class="comment">    * | |   SADDR += SOFF          | |             - SLAST Adjustment applied to SADDR after major loop</span></div><div class="line"><span class="comment">    * | |   DADDR += DOFF          | |             - DLAST Adjustment applied to DADDR after major loop</span></div><div class="line"><span class="comment">    * | | Total transfer is NBYTES | |             - CITER Major loop counter - counts how many minor loops</span></div><div class="line"><span class="comment">    * | +--------------------------+ |</span></div><div class="line"><span class="comment">    * |                              |            SLAST and DLAST may be used to reset the addresses to the initial value or</span></div><div class="line"><span class="comment">    * | At end of Major Loop         |            link to the next transfer.</span></div><div class="line"><span class="comment">    * |    SADDR += SLAST            |            The total transferred for the entire sequence is CITER x NBYTES.</span></div><div class="line"><span class="comment">    * |    DADDR += DLAST            |</span></div><div class="line"><span class="comment">    * |                              |            Important options in the CSR:</span></div><div class="line"><span class="comment">    * | Total transfer =             |              - DMA_CSR_INTMAJOR = Generate interrupt at end of Major-loop</span></div><div class="line"><span class="comment">    * |    CITER*NBYTES              |              - DMA_CSR_DREQ     = Clear hardware request at end of Major-loop</span></div><div class="line"><span class="comment">    * +------------------------------+              - DMA_CSR_START    = Start transfer. Used for software transfers. Automatically cleared.</span></div><div class="line"><span class="comment">    * @endverbatim</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * Structure to define the DMA transfer</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <a name="_a10"></a><a class="code" href="struct_u_s_b_d_m_1_1_dma_tcd.html">DmaTcd</a> txTcd {</div><div class="line">      <span class="comment">/* uint32_t  SADDR  Source address        */</span> (uint32_t)(txBuffer),                     <span class="comment">// Source array</span></div><div class="line">      <span class="comment">/* uint16_t  SOFF   SADDR offset          */</span> <span class="keyword">sizeof</span>(txBuffer[0]),                      <span class="comment">// SADDR advances 1 element for each request</span></div><div class="line">      <span class="comment">/* uint16_t  ATTR   Transfer attributes   */</span> dmaSSize(txBuffer[0])|                    <span class="comment">// Read size for SADDR</span></div><div class="line">      <span class="comment">/*                                        */</span> dmaDSize(spi.<a name="a11"></a><a class="code" href="class_u_s_b_d_m_1_1_spi___t.html#abeb092e38a7b2cb0a828573db2e5e1f0">SPI</a>-&gt;<a name="a12"></a><a class="code" href="struct_s_p_i___type.html#a6c80b733dbeb338bd00a076a787d1586">PUSHR</a>),                 <span class="comment">// Write size for DADDR</span></div><div class="line">      <span class="comment">/* uint32_t  NBYTES Minor loop byte count */</span> <span class="keyword">sizeof</span>(txBuffer[0]),                      <span class="comment">// Total transfer in one minor-loop</span></div><div class="line">      <span class="comment">/* uint32_t  SLAST  Last SADDR adjustment */</span> -<span class="keyword">sizeof</span>(txBuffer),                        <span class="comment">// Reset SADDR to start of array on completion</span></div><div class="line">      <span class="comment">/* uint32_t  DADDR  Destination address   */</span> (uint32_t)(&amp;spi.<a class="code" href="class_u_s_b_d_m_1_1_spi___t.html#abeb092e38a7b2cb0a828573db2e5e1f0">SPI</a>-&gt;<a class="code" href="struct_s_p_i___type.html#a6c80b733dbeb338bd00a076a787d1586">PUSHR</a>),              <span class="comment">// Destination is SPI PUSH data register</span></div><div class="line">      <span class="comment">/* uint16_t  DOFF   DADDR offset          */</span> 0,                                        <span class="comment">// DADDR doesn&#39;t change</span></div><div class="line">      <span class="comment">/* uint16_t  CITER  Major loop count      */</span> <a name="a13"></a><a class="code" href="group___d_m_a0___register___masks___g_r_o_u_p.html#ga90da234a92b743da263644fec6fb9b22">DMA_CITER_ELINKNO_ELINK</a>(0)|               <span class="comment">// No ELINK</span></div><div class="line">      <span class="comment">/*                                        */</span> ((<span class="keyword">sizeof</span>(txBuffer))/<span class="keyword">sizeof</span>(txBuffer[0])), <span class="comment">// Transfer entire txBuffer</span></div><div class="line">      <span class="comment">/* uint32_t  DLAST  Last DADDR adjustment */</span> 0,                                        <span class="comment">// DADDR doesn&#39;t change</span></div><div class="line">      <span class="comment">/* uint16_t  CSR    Control and Status    */</span> <a name="a14"></a><a class="code" href="group___d_m_a0___register___masks___g_r_o_u_p.html#ga19f9948f07166ffacc6c4eca2aa16368">DMA_CSR_INTMAJOR</a>(0)|                      <span class="comment">// Generate interrupt on completion of Major-loop</span></div><div class="line">      <span class="comment">/*                                        */</span> <a name="a15"></a><a class="code" href="group___d_m_a0___register___masks___g_r_o_u_p.html#gad12e18848970d071c8cf82ff61030f90">DMA_CSR_DREQ</a>(1)|                          <span class="comment">// Clear hardware request when complete major loop (non-stop)</span></div><div class="line">      <span class="comment">/*                                        */</span> <a name="a16"></a><a class="code" href="group___d_m_a0___register___masks___g_r_o_u_p.html#gadf8b3046d6c4f6a4577bd841c287a058">DMA_CSR_START</a>(0),                         <span class="comment">// Don&#39;t start (triggered by hardware)</span></div><div class="line">   };</div><div class="line"></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="struct_u_s_b_d_m_1_1_dma_tcd.html">DmaTcd</a> rxTcd {</div><div class="line">      <span class="comment">/* uint32_t  SADDR  Source address        */</span> (uint32_t)(&amp;spi.<a class="code" href="class_u_s_b_d_m_1_1_spi___t.html#abeb092e38a7b2cb0a828573db2e5e1f0">SPI</a>-&gt;<a name="a17"></a><a class="code" href="struct_s_p_i___type.html#a05364b40687e08bc41dac6e8c36c902e">POPR</a>),               <span class="comment">// Source is SPI POPR data register</span></div><div class="line">      <span class="comment">/* uint16_t  SOFF   SADDR offset          */</span> 0,                                        <span class="comment">// SADDR adoesn&#39;t change</span></div><div class="line">      <span class="comment">/* uint16_t  ATTR   Transfer attributes   */</span> dmaSSize(rxBuffer[0])|                    <span class="comment">// Read size for SADDR (read 1 byte, discards 3)</span></div><div class="line">      <span class="comment">/*                                        */</span> dmaDSize(rxBuffer[0]),                    <span class="comment">// Write size to DADDR</span></div><div class="line">      <span class="comment">/* uint32_t  NBYTES Minor loop byte count */</span> <span class="keyword">sizeof</span>(rxBuffer[0]),                      <span class="comment">// Total transfer in one minor-loop</span></div><div class="line">      <span class="comment">/* uint32_t  SLAST  Last SADDR adjustment */</span> 0,                                        <span class="comment">// SADDR doesn&#39;t change</span></div><div class="line">      <span class="comment">/* uint32_t  DADDR  Destination address   */</span> (uint32_t)(rxBuffer),                     <span class="comment">// Destination array</span></div><div class="line">      <span class="comment">/* uint16_t  DOFF   DADDR offset          */</span> <span class="keyword">sizeof</span>(rxBuffer[0]),                      <span class="comment">// DADDR advances 1 element for each request</span></div><div class="line">      <span class="comment">/* uint16_t  CITER  Major loop count      */</span> <a class="code" href="group___d_m_a0___register___masks___g_r_o_u_p.html#ga90da234a92b743da263644fec6fb9b22">DMA_CITER_ELINKNO_ELINK</a>(0)|               <span class="comment">// No ELINK</span></div><div class="line">      <span class="comment">/*                                        */</span> ((<span class="keyword">sizeof</span>(rxBuffer))/<span class="keyword">sizeof</span>(rxBuffer[0])), <span class="comment">// Transfer entire txBuffer</span></div><div class="line">      <span class="comment">/* uint32_t  DLAST  Last DADDR adjustment */</span> -<span class="keyword">sizeof</span>(rxBuffer),                        <span class="comment">// Reset DADDR to start of array on completion</span></div><div class="line">      <span class="comment">/* uint16_t  CSR    Control and Status    */</span> <a class="code" href="group___d_m_a0___register___masks___g_r_o_u_p.html#ga19f9948f07166ffacc6c4eca2aa16368">DMA_CSR_INTMAJOR</a>(1)|                      <span class="comment">// Generate interrupt on completion of Major-loop</span></div><div class="line">      <span class="comment">/*                                        */</span> <a class="code" href="group___d_m_a0___register___masks___g_r_o_u_p.html#gad12e18848970d071c8cf82ff61030f90">DMA_CSR_DREQ</a>(1)|                          <span class="comment">// Clear hardware request when complete major loop (non-stop)</span></div><div class="line">      <span class="comment">/*                                        */</span> <a class="code" href="group___d_m_a0___register___masks___g_r_o_u_p.html#gadf8b3046d6c4f6a4577bd841c287a058">DMA_CSR_START</a>(0),                         <span class="comment">// Don&#39;t start (triggered by hardware)</span></div><div class="line">   };</div><div class="line"></div><div class="line">   <span class="comment">// Sequence not complete yet</span></div><div class="line">   complete = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">   <span class="comment">// Enable DMAC with default settings</span></div><div class="line">   <a name="a18"></a><a class="code" href="class_u_s_b_d_m_1_1_dma___t.html#a8b97997ed95e7ff8d0f314dd269dc11d">Dma0::configure</a>();</div><div class="line"></div><div class="line">   <span class="comment">// Set callback (Interrupts are enabled in TCD)</span></div><div class="line">   <a name="a19"></a><a class="code" href="class_u_s_b_d_m_1_1_dma___t.html#a272b46f2d8de36e0df0bc860d687a83b">Dma0::setCallback</a>(DMA_TX_CHANNEL, dmaCallback);</div><div class="line">   <a name="a20"></a><a class="code" href="class_u_s_b_d_m_1_1_dma___t.html#a2516fcb4e018811b9bfe7e1c215aca47">Dma0::enableNvicInterrupts</a>(DMA_TX_CHANNEL);</div><div class="line"></div><div class="line">   <span class="comment">// Set callback (Interrupts are enabled in TCD)</span></div><div class="line">   <a class="code" href="class_u_s_b_d_m_1_1_dma___t.html#a272b46f2d8de36e0df0bc860d687a83b">Dma0::setCallback</a>(DMA_RX_CHANNEL, dmaCallback);</div><div class="line">   <a class="code" href="class_u_s_b_d_m_1_1_dma___t.html#a2516fcb4e018811b9bfe7e1c215aca47">Dma0::enableNvicInterrupts</a>(DMA_RX_CHANNEL);</div><div class="line"></div><div class="line">   <span class="comment">// Connect DMA channel to SPI Tx</span></div><div class="line">   <a name="a21"></a><a class="code" href="class_u_s_b_d_m_1_1_dma_mux___t.html#a985bb6e43c312fa84e150b930412bae9">DmaMux0::configure</a>(DMA_TX_CHANNEL, <a name="a22"></a><a class="code" href="group___d_m_a_m_u_x___group.html#ggaf26d2f5eaed2a157020062606f7527f8a880877f0953e51e0344e0bf327e45cd0">DmaSlot_SPI0_Transmit</a>, <a name="a23"></a><a class="code" href="group___d_m_a___group.html#ggaf45af97259922f16e01ad5cbe09cfe4aa9d3eb30900f80b9368dfed376f6a5d9c">DmaMuxEnable_Continuous</a>);</div><div class="line"></div><div class="line">   <span class="comment">// Connect DMA channel to SPI Rx</span></div><div class="line">   <a class="code" href="class_u_s_b_d_m_1_1_dma_mux___t.html#a985bb6e43c312fa84e150b930412bae9">DmaMux0::configure</a>(DMA_RX_CHANNEL, <a name="a24"></a><a class="code" href="group___d_m_a_m_u_x___group.html#ggaf26d2f5eaed2a157020062606f7527f8aca3bedc28a09b81a6b1b1320240b3f7d">DmaSlot_SPI0_Receive</a>, <a class="code" href="group___d_m_a___group.html#ggaf45af97259922f16e01ad5cbe09cfe4aa9d3eb30900f80b9368dfed376f6a5d9c">DmaMuxEnable_Continuous</a>);</div><div class="line"></div><div class="line">   <span class="comment">// Configure the Tx transfer</span></div><div class="line">   <a name="a25"></a><a class="code" href="class_u_s_b_d_m_1_1_dma___t.html#a330285b7e4cf5e756ef702c8c3f158ee">Dma0::configureTransfer</a>(DMA_TX_CHANNEL, txTcd);</div><div class="line"></div><div class="line">   <span class="comment">// Configure the Rx transfer</span></div><div class="line">   <a class="code" href="class_u_s_b_d_m_1_1_dma___t.html#a330285b7e4cf5e756ef702c8c3f158ee">Dma0::configureTransfer</a>(DMA_RX_CHANNEL, rxTcd);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * SPI callback</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Used for debug timing checks.</span></div><div class="line"><span class="comment"> * LED toggles on each SPI event</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param status Interrupt status value from SPI-&gt;SR</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> spiCallback(uint32_t) {</div><div class="line">   Led::toggle();</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Configure SPI</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> configureSpi() {</div><div class="line">   spi.<a name="a26"></a><a class="code" href="class_u_s_b_d_m_1_1_spi___t.html#a12a9f39d4456a6647a98ab6c4b95cbce">setSpeed</a>(20000000);</div><div class="line">   spi.<a name="a27"></a><a class="code" href="class_u_s_b_d_m_1_1_spi___t.html#acbf301257cd625fffb3737c74a522e64">setDelays</a>(50*ns, 50*ns, 1*us);</div><div class="line">   spi.<a name="a28"></a><a class="code" href="class_u_s_b_d_m_1_1_spi_irq___t.html#a2276134d56282585916abefdf9b249e0">setCallback</a>(spiCallback);</div><div class="line">   spi.<a name="a29"></a><a class="code" href="class_u_s_b_d_m_1_1_spi.html#aec6ea2bf07849283a2f9d5a8a1128653">configureInterrupts</a>(</div><div class="line">         <a name="a30"></a><a class="code" href="group___s_p_i___group.html#gga24da8a6a97bc07dfa541aa1ff123133ea78fe17a06fb7dae03e0646589cb9fd1f">SpiTxCompleteInterrupt_Enabled</a>,</div><div class="line">         <a name="a31"></a><a class="code" href="group___s_p_i___group.html#gga78518edc7052d91f8c4685f4827d0064ac4ba4d91a0913773e0d0bee0b2a953ff">SpiEndOfQueueInterrupt_Enable</a>,</div><div class="line">         <a name="a32"></a><a class="code" href="group___s_p_i___group.html#ggaa1b02c943327bca3733dae0586a26489a87cafbf6da5a8eebaa795e91d1cc6764">SpiFifoUnderflowInterrupt_Enabled</a>,</div><div class="line">         <a name="a33"></a><a class="code" href="group___s_p_i___group.html#ggad16f361d50392ae9c2b482346bff226da325d1ed2b180cb430d8564b5bdc621f1">SpiFifoOverflowInterrupt_Enabled</a>);</div><div class="line">   spi.<a name="a34"></a><a class="code" href="class_u_s_b_d_m_1_1_spi.html#aff44a226f7f5d54a680eab9c1cc026fc">configureFifoRequests</a>(<a name="a35"></a><a class="code" href="group___s_p_i___group.html#ggab9c61acefc026b506de46a7d251980c5a6473c0fd70acb526e269aada9cd7ba50">SpiFifoTxRequest_Dma</a>, <a name="a36"></a><a class="code" href="group___s_p_i___group.html#gga166d71a39a4435151adbcfd0776e5f42a4ad1fe42affd2d19652902fd16528904">SpiFifoRxRequest_Dma</a>);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Start transfer</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> doTransfer() {</div><div class="line"><span class="comment">//   spi.spi-&gt;PUSHR_CONTROL = SPI_PUSHR_CONTROL_CTAS(0)|SPI_PUSHR_CONTROL_PCS(1);</span></div><div class="line">   complete = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">   spi.<a name="a37"></a><a class="code" href="class_u_s_b_d_m_1_1_spi___t.html#a75c7f48e26ab2c087cb23a02ef67dba4">getStatus</a>();</div><div class="line">   spi.<a name="a38"></a><a class="code" href="class_u_s_b_d_m_1_1_spi.html#a676b0b2122bae8364b0cf85396c256dc">enableTransfer</a>();</div><div class="line"></div><div class="line">   <span class="comment">// Enable Rx hardware requests</span></div><div class="line">   <a name="a39"></a><a class="code" href="class_u_s_b_d_m_1_1_dma___t.html#a8f858ba0e0206e6839ea990396020759">Dma0::enableRequests</a>(DMA_RX_CHANNEL);</div><div class="line"></div><div class="line">   <span class="comment">// Enable Tx hardware requests</span></div><div class="line">   <a class="code" href="class_u_s_b_d_m_1_1_dma___t.html#a8f858ba0e0206e6839ea990396020759">Dma0::enableRequests</a>(DMA_TX_CHANNEL);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a40"></a><a class="code" href="main_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div><div class="line">   __asm__(<span class="stringliteral">&quot;nop&quot;</span>);</div><div class="line"></div><div class="line">   printf(<span class="stringliteral">&quot;Starting\n&quot;</span>);</div><div class="line"></div><div class="line">   Led::setOutput();</div><div class="line"></div><div class="line">   <span class="comment">// Set up DMA transfer from memory -&gt; SPI</span></div><div class="line">   initDma();</div><div class="line">   configureSpi();</div><div class="line"></div><div class="line">   <span class="keywordflow">for</span>(;;) {</div><div class="line">      <span class="comment">// Do a transfer</span></div><div class="line">      doTransfer();</div><div class="line"></div><div class="line">      <span class="comment">// Wait for completion of 1 Major-loop = 1 txBuffer</span></div><div class="line">      <span class="keywordflow">while</span> (!complete) {</div><div class="line">         __asm__(<span class="stringliteral">&quot;nop&quot;</span>);</div><div class="line">      }</div><div class="line">      <span class="comment">// Check expected Rx data</span></div><div class="line">      <span class="keywordflow">if</span> (memcmp(rxBuffer, rxTestBuffer, <span class="keyword">sizeof</span>(rxBuffer)) != 0) {</div><div class="line">         printf(<span class="stringliteral">&quot;Failed\n&quot;</span>);</div><div class="line">         <a name="a41"></a><a class="code" href="group___c_m_s_i_s___core___instruction_interface.html#ga15ea6bd3c507d3e81c3b3a1258e46397">__BKPT</a>();</div><div class="line">      }</div><div class="line">      <span class="keywordflow">else</span> {</div><div class="line"><span class="comment">//         printf(&quot;Success\n&quot;);</span></div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="comment">// Stop the UART DMA requests</span></div><div class="line">   <span class="comment">//   uart.enableDma(UartDma_TxHoldingEmpty, false);</span></div><div class="line"></div><div class="line">   printf(<span class="stringliteral">&quot;Done 1st txBuffer\n&quot;</span>);</div><div class="line">   <a name="a42"></a><a class="code" href="delay_8h.html#a559f65839b6a67e60dd46669b5712ab6">wait</a>(4000*ms);</div><div class="line"></div><div class="line">   <span class="comment">// Start the UART DMA requests again</span></div><div class="line">   printf(<span class="stringliteral">&quot;More coming....\n&quot;</span>);</div><div class="line">   <span class="comment">//   uart.enableDma(UartDma_TxHoldingEmpty);</span></div><div class="line"></div><div class="line">   <span class="keywordflow">for</span>(;;) {</div><div class="line">      __asm__(<span class="stringliteral">&quot;nop&quot;</span>);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Aug 12 2017 08:54:36 for USBDM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
