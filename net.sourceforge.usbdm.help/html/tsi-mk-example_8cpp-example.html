<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USBDM: tsi-mk-example.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USBDM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">tsi-mk-example.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> ============================================================================</span></div><div class="line"><span class="comment"> * @file    tsi-mk-example.cpp (180.ARM_Peripherals)</span></div><div class="line"><span class="comment"> * @brief   Basic C++ demo using TSI class</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  Created on: 10/1/2016</span></div><div class="line"><span class="comment"> *      Author: podonoghue</span></div><div class="line"><span class="comment"> ============================================================================</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="system_8h.html">system.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="derivative_8h.html">derivative.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hardware_8h.html">hardware.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="delay_8h.html">delay.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="tsi_8h.html">tsi.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_u_s_b_d_m.html">USBDM</a>;</div><div class="line"></div><div class="line"><span class="comment">// LED connections - change as required</span></div><div class="line"><span class="keyword">using</span> LedA = <a name="_a0"></a><a class="code" href="class_u_s_b_d_m_1_1_gpio_a.html">USBDM::GpioA&lt;2,ActiveLow&gt;</a>;</div><div class="line"><span class="keyword">using</span> LedB = <a name="_a1"></a><a class="code" href="class_u_s_b_d_m_1_1_gpio_c.html">USBDM::GpioC&lt;3,ActiveLow&gt;</a>;</div><div class="line"></div><div class="line"><span class="keyword">using</span> MeasurementPin = <a name="_a2"></a><a class="code" href="class_u_s_b_d_m_1_1_gpio_e.html">USBDM::GpioE&lt;1&gt;</a>;</div><div class="line"></div><div class="line"><span class="comment">// TSI electrodes to use</span></div><div class="line">constexpr uint32_t electrodeA = 11;</div><div class="line">constexpr uint32_t electrodeB = 12;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Flag used to communicate between ISR and foreground task.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">bool</span> complete = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">uint32_t savedStatus = 0;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> tsiCallback(uint32_t status) {</div><div class="line">   savedStatus = status&amp;(<a name="a3"></a><a class="code" href="group___t_s_i___register___masks___g_r_o_u_p.html#gae0670e2e8c0eb55717171acb5a2bebfe">TSI_GENCS_OUTRGF_MASK</a>|<a name="a4"></a><a class="code" href="group___t_s_i___register___masks___g_r_o_u_p.html#ga9d9ee2965d913e5b2eb7a9a71a5c26e8">TSI_GENCS_OVRF_MASK</a>|<a name="a5"></a><a class="code" href="group___t_s_i___register___masks___g_r_o_u_p.html#ga33e3d274099483b6ebf7897b7d72b866">TSI_GENCS_EXTERF_MASK</a>);</div><div class="line">   <span class="comment">// Flag new values available.</span></div><div class="line">   complete = <span class="keyword">true</span>;</div><div class="line">   <span class="comment">// To confirm sample interval</span></div><div class="line">   MeasurementPin::toggle();</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Configure TSI</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param[in] periodic True to set up TSI for periodic scanning with ISR</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> initTsi(<span class="keywordtype">bool</span> periodic) {</div><div class="line"></div><div class="line">   <span class="comment">// Alternative - use Configure.usbdmProject settings</span></div><div class="line"><span class="comment">//   Tsi0::defaultConfigure();</span></div><div class="line"></div><div class="line">   <span class="comment">// Enable TSI</span></div><div class="line">   <a name="a6"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a6266f512ccfd840864ec8ff1faff9d01">Tsi0::enable</a>();</div><div class="line">   <span class="comment">// Set clock source (and divider and modulus)</span></div><div class="line">   <a name="a7"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a2dfca52204d9281bf0efb80ac8547862">Tsi0::setClock</a>(<a name="a8"></a><a class="code" href="namespace_u_s_b_d_m.html#aa76b9ecf23c985e143eb167057d95da0a411e70f3230cf50eddf4d94c515d50a7">TsiClockSource_LpOscClk</a>);</div><div class="line">   <span class="comment">// Set Low power clock - off</span></div><div class="line">   <a name="a9"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a1c9f314b6cea1e29f03da5c03e3c82e4">Tsi0::setLowPowerClock</a>(<a name="a10"></a><a class="code" href="namespace_u_s_b_d_m.html#a3485ec01a7114807dde9c64fb484c349ac6cd16a7d0bc23ea861dd7b1e62de00e">TsiStopMode_Disabled</a>);</div><div class="line">   <span class="comment">// Enable these two inputs</span></div><div class="line">   <a name="a11"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a747be50edb324ca24d3db707b63e4344">Tsi0::selectInputs</a>((1&lt;&lt;electrodeA)|(1&lt;&lt;electrodeB), electrodeA);</div><div class="line">   <span class="comment">// Set charge currents</span></div><div class="line">   <a name="a12"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#aa54b9d9b5d80de2d9c735d28ceb56eba">Tsi0::setCurrents</a>(16,16);</div><div class="line">   <span class="comment">// This affects the electrode sample interval and needs to be a compromise</span></div><div class="line">   <span class="comment">// that satisfies noise, speed and avoiding count overflow</span></div><div class="line">   <a name="a13"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a55c8db0c957b8d7dfa645dd0947aad69">Tsi0::setScans</a>(<a name="a14"></a><a class="code" href="namespace_u_s_b_d_m.html#a515947485b1a2305b4e91ba31c282cdfae537efb68c331e00734db22f429bf13b">TsiElectrodePrescaler_2</a>, 8);</div><div class="line"></div><div class="line">   <a name="a15"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_irq___t.html#a5581d0c57b238afc810cc69902fc3b8f">Tsi0::setCallback</a>(tsiCallback);</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (periodic) {</div><div class="line">      <span class="comment">// This overrides the clock divider and modulus set earlier</span></div><div class="line">      <span class="comment">// It must be large enough to allow for the worse case sampling of all electrodes</span></div><div class="line">      <a name="a16"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a0de57b6b6c841441d6fd2c399f09cb65">Tsi0::setSamplePeriod</a>(10*ms);</div><div class="line"></div><div class="line">      <span class="comment">// Start periodic scans</span></div><div class="line">      <a name="a17"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a639208fe2367a2ac3a1ccb3aadb2a3f1">Tsi0::startScan</a>(<a name="a18"></a><a class="code" href="namespace_u_s_b_d_m.html#a039419c3520062b2d13d2f754f31eabdabaaacc299fa6cba7d6217636d2a117e8">TsiScanMode_Periodic</a>);</div><div class="line"></div><div class="line">      <span class="comment">// Enable interrupts</span></div><div class="line">      <a name="a19"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#ae1c8fe244167714595f87db4eebad5ab">Tsi0::enableTsiInterrupts</a>(<a name="a20"></a><a class="code" href="namespace_u_s_b_d_m.html#a11d279a830c1920d8f72fae0958bc55ea8e8975d3e721876e884db80355a71747">TsiInterrupt_EndOfScan</a>, <a name="a21"></a><a class="code" href="namespace_u_s_b_d_m.html#a37cd54c5f031cffb4ce35446c88fca78abd5897eaf17933b904803de63cee24fd">TsiErrorInterrupt_Enable</a>);</div><div class="line">      <a name="a22"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a15f216192896d163a9419b4981bf5220">Tsi0::enableNvicInterrupts</a>();</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">// Check for errors so far</span></div><div class="line">   checkError();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * The pulse output is intended to be measured on an oscilloscope.</span></div><div class="line"><span class="comment"> * The high-time shows the approximate sample time for the active inputs.</span></div><div class="line"><span class="comment"> * This will vary with capacitance (finger!)</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This uses software triggered mode.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> measureScanTime() {</div><div class="line">   MeasurementPin::setOutput();</div><div class="line">   initTsi(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">   <span class="keywordflow">for</span>(;;) {</div><div class="line">      MeasurementPin::set();</div><div class="line">      <a name="a23"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a44c2f002b5d162f173191bb88faccc26">Tsi0::startScanAndWait</a>();</div><div class="line">      MeasurementPin::clear();</div><div class="line">      <a name="a24"></a><a class="code" href="delay_8h.html#acba846c9e7c31723fb8693aed8fb4aed">waitUS</a>(200);</div><div class="line">   }</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * An example that scans two electrodes using hardware scan mode.</span></div><div class="line"><span class="comment"> * A simple calibration is done initially and then the two electrodes</span></div><div class="line"><span class="comment"> * are used to control two LEDs in a simple on-off fashion.</span></div><div class="line"><span class="comment"> * The electrode measurements are printed to stdout.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The measurement output toggle on each sample sequence.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> tsiExample() {</div><div class="line">   MeasurementPin::setOutput();</div><div class="line"></div><div class="line">   uint16_t chAMin, chAMax, chAThreshold, chBMin, chBMax, chBThreshold;</div><div class="line">   LedA::setOutput();</div><div class="line">   LedB::setOutput();</div><div class="line"></div><div class="line">   <span class="comment">// Configure as Software-triggered</span></div><div class="line">   initTsi(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">   <span class="comment">// Wait for first successful conversion</span></div><div class="line">   <span class="keywordflow">while</span> (<a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a44c2f002b5d162f173191bb88faccc26">Tsi0::startScanAndWait</a>() != <a name="a25"></a><a class="code" href="namespace_u_s_b_d_m.html#af5406ca776612b2687e916fb194ffd26a4ba45ce064022eb4eb90e52c3d48a83a">E_NO_ERROR</a>) {</div><div class="line">   }</div><div class="line">   <span class="comment">// Start min/max at first measurement +/- delta</span></div><div class="line">   <span class="keyword">static</span> constexpr <span class="keywordtype">int</span> delta = 0;</div><div class="line">   chAMin = std::max(0,     <a name="a26"></a><a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a88e5d0575db441f515d96f770f65480f">Tsi0::getCount</a>(electrodeA)-delta);</div><div class="line">   chAMax = std::min(65535, <a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a88e5d0575db441f515d96f770f65480f">Tsi0::getCount</a>(electrodeA)+delta);</div><div class="line">   chBMin = std::max(0,     <a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a88e5d0575db441f515d96f770f65480f">Tsi0::getCount</a>(electrodeB)-delta);</div><div class="line">   chBMax = std::min(65535, <a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a88e5d0575db441f515d96f770f65480f">Tsi0::getCount</a>(electrodeB)+delta);</div><div class="line"></div><div class="line">   <span class="comment">// Reconfigure as Hardware-triggered (periodic)</span></div><div class="line">   <span class="comment">// with interrupts</span></div><div class="line">   initTsi(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">   <span class="keywordflow">for</span>(;;) {</div><div class="line">      complete = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">      <span class="comment">// Wait until ISR called</span></div><div class="line">      <span class="keywordflow">while</span> (!complete) {</div><div class="line">         <span class="keywordflow">if</span> (savedStatus != 0) {</div><div class="line">            <span class="comment">// The overrun flag gets set for some reason even if the timing is generous</span></div><div class="line">            <span class="comment">// When it happens you have to restart due to errata e4181</span></div><div class="line">            initTsi(<span class="keyword">true</span>);</div><div class="line">         }</div><div class="line">         __asm__(<span class="stringliteral">&quot;nop&quot;</span>);</div><div class="line">      }</div><div class="line">      <span class="comment">// Delay required due to errata e2638</span></div><div class="line">      <a class="code" href="delay_8h.html#acba846c9e7c31723fb8693aed8fb4aed">waitUS</a>(250);</div><div class="line"></div><div class="line">      <span class="comment">// Read two active electrodes</span></div><div class="line">      uint16_t chA = <a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a88e5d0575db441f515d96f770f65480f">Tsi0::getCount</a>(electrodeA);</div><div class="line">      uint16_t chB = <a class="code" href="class_u_s_b_d_m_1_1_tsi_base___t.html#a88e5d0575db441f515d96f770f65480f">Tsi0::getCount</a>(electrodeB);</div><div class="line"></div><div class="line">      <span class="comment">// Adjust min/max</span></div><div class="line">      chAMin = std::min(chA, chAMin);</div><div class="line">      chAMax = std::max(chA, chAMax);</div><div class="line">      chBMin = std::min(chB, chBMin);</div><div class="line">      chBMax = std::max(chB, chBMax);</div><div class="line"></div><div class="line">      <span class="comment">// Update thresholds - biased towards low sample</span></div><div class="line">      chAThreshold = (3*chAMin+chAMax)/4;</div><div class="line">      chBThreshold = (3*chBMin+chBMax)/4;</div><div class="line"></div><div class="line">      <span class="comment">// Values are compared to thresholds</span></div><div class="line">      <span class="keywordtype">bool</span> chAOn = chA&gt;chAThreshold;</div><div class="line">      <span class="keywordtype">bool</span> chBOn = chB&gt;chBThreshold;</div><div class="line"></div><div class="line">      <span class="comment">// Update LEDs</span></div><div class="line">      LedA::write(chAOn);</div><div class="line">      LedB::write(chBOn);</div><div class="line"></div><div class="line">      <span class="comment">// Report values</span></div><div class="line">      printf(<span class="stringliteral">&quot;chA=%s(%5d) chB=%s(%5d)\n&quot;</span>, (chAOn)?<span class="stringliteral">&quot;On &quot;</span>:<span class="stringliteral">&quot;Off&quot;</span>, chA, (chBOn)?<span class="stringliteral">&quot;On &quot;</span>:<span class="stringliteral">&quot;Off&quot;</span>, chB);</div><div class="line">   }</div><div class="line"></div><div class="line">}</div><div class="line"><span class="keywordtype">int</span> <a name="a27"></a><a class="code" href="main_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div><div class="line"></div><div class="line"><span class="comment">//   measureScanTime();</span></div><div class="line">   tsiExample();</div><div class="line"></div><div class="line">   <span class="keywordflow">for</span>(;;) {</div><div class="line">      __asm__(<span class="stringliteral">&quot;nop&quot;</span>);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Aug 12 2017 08:54:36 for USBDM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
