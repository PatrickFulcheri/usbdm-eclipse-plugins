<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USBDM: usb_cdc_interface.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USBDM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">usb_cdc_interface.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @file     usb_cdc_interface.cpp</span></div><div class="line"><span class="comment"> * @brief    USB-UART interface</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This module handles the UART interface for USB CDC</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @version  V4.12.1.80</span></div><div class="line"><span class="comment"> * @date     13 April 2016</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hardware_8h.html">hardware.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="uart_8h.html">uart.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="queue_8h.html">queue.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;usb_cdc_interface.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespace_u_s_b_d_m.html">USBDM</a> {</div><div class="line"></div><div class="line"><span class="comment">// Which UART to use</span></div><div class="line"><span class="keyword">using</span> UartInfo = Uart0Info;</div><div class="line"></div><div class="line"><span class="keyword">static</span> uint8_t             cdcStatus            = 0;</div><div class="line"><span class="keyword">static</span> <a name="_a0"></a><a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a> currentLineCoding    = {0, 0, 0, 0};</div><div class="line"><span class="keyword">static</span> uint8_t             breakCount           = 0;</div><div class="line"><span class="keyword">static</span> bool              (*inCallback)()        = <span class="keyword">nullptr</span>;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** Queue of outgoing characters CDC -&gt; UART */</span></div><div class="line"><span class="keyword">static</span> <a name="_a1"></a><a class="code" href="class_queue.html">Queue&lt;char, 100&gt;</a> outQueue;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** Queue of incoming characters UART -&gt; CDC */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="class_queue.html">Queue&lt;char, 100&gt;</a> inQueue;</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Interrupt callback for UART</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> uartCallback(uint8_t status);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Initialise class</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> CDC_Interface::initialise() {</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Set USB notify function</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param cb The function to call to notify the USB In interface that new data is available</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> CDC_Interface::setUsbInNotifyCallback(simpleCallbak cb) {</div><div class="line">   inCallback = cb;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Process data received from host</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param size Amount of data</span></div><div class="line"><span class="comment"> * @param buff Buffer containing data</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @note the Data is volatile so should be processed or saved immediately.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> CDC_Interface::putData(<span class="keywordtype">int</span> size, <span class="keyword">const</span> uint8_t *buff) {</div><div class="line">   <span class="keywordflow">while</span> (size--&gt;0) {</div><div class="line">      <span class="keywordflow">if</span> (outQueue.<a name="a2"></a><a class="code" href="class_queue.html#aea4d4ca23fec2964a33e21afb502a383">isFull</a>()) {</div><div class="line">         cdcStatus |= <a name="a3"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gac8102fb901477551dcc8505b3afb5272">UART_S1_OR_MASK</a>;</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      }</div><div class="line">      outQueue.<a name="a4"></a><a class="code" href="class_queue.html#a2610b19a7fc31d94db559fa3c933622e">enQueue</a>(*buff++);</div><div class="line">   }</div><div class="line">   <span class="comment">// Restart Transmit IRQ</span></div><div class="line">   UartInfo::uart-&gt;C2 |= <a name="a5"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga0b4f935e44fda4076d7c8964c9d1e409">UART_C2_TIE_MASK</a>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get data to transmit to host</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param bufSize Size of buffer</span></div><div class="line"><span class="comment"> * @param buff    Buffer for data</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return Amount of data placed in buffer</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> CDC_Interface::getData(<span class="keywordtype">int</span> bufSize, uint8_t *buff) {</div><div class="line">   <span class="keywordtype">int</span> size = 0;</div><div class="line">   <span class="keywordflow">while</span> (size&lt;bufSize) {</div><div class="line">      <span class="keywordflow">if</span> (inQueue.<a name="a6"></a><a class="code" href="class_queue.html#a46339c85f72f5dc98fc11b34bf67b08a">isEmpty</a>()) {</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">      size++;</div><div class="line">      *buff++ = inQueue.<a name="a7"></a><a class="code" href="class_queue.html#ab0a5488a4757115f4dd3e8ba1f550334">deQueue</a>();</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> size;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get state of serial interface</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return Bit mask value</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><a name="_a8"></a><a class="code" href="struct_cdc_line_state.html">CdcLineState</a> CDC_Interface::getSerialState() {</div><div class="line"></div><div class="line">   <span class="keyword">static</span> uint8_t lastSciStatus = 0x00;</div><div class="line"></div><div class="line">   <span class="comment">// Assume DCD &amp; DSR</span></div><div class="line">   <a class="code" href="struct_cdc_line_state.html">CdcLineState</a> status = {CDC_STATE_DCD_MASK|CDC_STATE_DSR_MASK};</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (cdcStatus&amp;<a name="a9"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga83b62a5246fdb7f0aaaffb92074c9e0f">UART_S1_FE_MASK</a>) {</div><div class="line">      status.<a name="a10"></a><a class="code" href="struct_cdc_line_state.html#a89bca9470794428986245a5fd0667e9c">bits</a> |= CDC_STATE_FRAME_MASK;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (cdcStatus&amp;<a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gac8102fb901477551dcc8505b3afb5272">UART_S1_OR_MASK</a>) {</div><div class="line">      status.<a class="code" href="struct_cdc_line_state.html#a89bca9470794428986245a5fd0667e9c">bits</a> |= CDC_STATE_OVERRUN_MASK;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (cdcStatus&amp;<a name="a11"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga4116bba67a2cf49c9623e62e3b499ee3">UART_S1_PF_MASK</a>) {</div><div class="line">      status.<a class="code" href="struct_cdc_line_state.html#a89bca9470794428986245a5fd0667e9c">bits</a> |= CDC_STATE_PARITY_MASK;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (lastSciStatus != cdcStatus) {</div><div class="line">      <span class="comment">// Remember error status so we only report changes</span></div><div class="line">      lastSciStatus  = cdcStatus&amp;(UART_S1_FE_MASK|UART_S1_OR_MASK|<a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga4116bba67a2cf49c9623e62e3b499ee3">UART_S1_PF_MASK</a>);</div><div class="line">      status.<a class="code" href="struct_cdc_line_state.html#a89bca9470794428986245a5fd0667e9c">bits</a>   |= CDC_STATE_CHANGE_MASK;</div><div class="line">   }</div><div class="line">   cdcStatus = 0;</div><div class="line">   <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  Set CDC communication characteristics</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param lineCodingStructure - Structure describing desired settings</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The UART is quite limited when compared to the serial interface implied</span></div><div class="line"><span class="comment"> * by LineCodingStructure.</span></div><div class="line"><span class="comment"> * It does not support many of the combinations available.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> CDC_Interface::setLineCoding(<a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a> * <span class="keyword">const</span> lineCoding) {</div><div class="line">   uint8_t  UARTC1Value = 0x00;</div><div class="line">   uint8_t  UARTC3Value = 0x00;</div><div class="line"></div><div class="line">   <span class="comment">// Initialise UART and set baud rate</span></div><div class="line">   Uart_T&lt;UartInfo&gt; uart(<a name="a12"></a><a class="code" href="utilities_8h.html#aad03dc4f6b8bcbf5c356565610343e37">leToNative32</a>(lineCoding-&gt;<a name="a13"></a><a class="code" href="struct_line_coding_structure.html#a26727c8652d7ac68431f5857a9f7b8d1">dwDTERate</a>));</div><div class="line"></div><div class="line">   <a name="_a14"></a><a class="code" href="class_u_s_b_d_m_1_1_uart_irq___t.html">USBDM::UartIrq_T&lt;UartInfo&gt;::setCallback</a>(uartCallback);</div><div class="line"></div><div class="line">   cdcStatus  = CDC_STATE_CHANGE_MASK;</div><div class="line">   breakCount = 0; <span class="comment">// Clear any current BREAKs</span></div><div class="line"></div><div class="line">   (void)memcpy(&amp;currentLineCoding, lineCoding, <span class="keyword">sizeof</span>(<a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a>));</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   //! Note - for a 48MHz bus speed the useful baud range is ~300 to ~115200 for 0.5% error</span></div><div class="line"><span class="comment"></span>   <span class="comment">//  230400 &amp; 460800 have a 8.5% error</span></div><div class="line"></div><div class="line">   <span class="comment">// Configure pins</span></div><div class="line">   UartInfo::initPCRs();</div><div class="line"></div><div class="line">   <span class="comment">// Disable the transmitter and receiver while changing settings.</span></div><div class="line">   UartInfo::uart-&gt;C2 &amp;= ~(<a name="a15"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga3ac02e42b689641339aadf50ba868492">UART_C2_TE_MASK</a> | <a name="a16"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga181a8e8fd0f780d45f1bff7c76836fe5">UART_C2_RE_MASK</a> );</div><div class="line"></div><div class="line">   <span class="comment">// Note: lineCoding.bCharFormat is ignored (always 1 stop bit)</span></div><div class="line">   <span class="comment">//   switch (lineCoding.bCharFormat) {</span></div><div class="line">   <span class="comment">//      case 0:  // 1 bits</span></div><div class="line">   <span class="comment">//      case 1:  // 1.5 bits</span></div><div class="line">   <span class="comment">//      case 2:  // 2 bits</span></div><div class="line">   <span class="comment">//   }</span></div><div class="line"></div><div class="line">   <span class="comment">// Available combinations</span></div><div class="line">   <span class="comment">//============================================</span></div><div class="line">   <span class="comment">// Data bits  Parity   Stop |  M   PE  PT  T8</span></div><div class="line">   <span class="comment">//--------------------------------------------</span></div><div class="line">   <span class="comment">//     7      Odd       1   |  0   1   1   X</span></div><div class="line">   <span class="comment">//     7      Even      1   |  0   1   0   X</span></div><div class="line">   <span class="comment">//     8      None      1   |  0   0   X   X</span></div><div class="line">   <span class="comment">//     8      Odd       1   |  1   1   1   X</span></div><div class="line">   <span class="comment">//     8      Even      1   |  1   1   0   X</span></div><div class="line">   <span class="comment">//     8      Mark      1   |  1   0   X   0</span></div><div class="line">   <span class="comment">//     8      Space     1   |  1   0   X   1</span></div><div class="line">   <span class="comment">//--------------------------------------------</span></div><div class="line">   <span class="comment">//   All other values default to 8-None-1</span></div><div class="line"></div><div class="line">   <span class="keywordflow">switch</span> (lineCoding-&gt;<a name="a17"></a><a class="code" href="struct_line_coding_structure.html#a2bea24b1b35e16ebe506abeeb8e5e233">bDataBits</a>) {</div><div class="line">   <span class="comment">// 5,6,7,8,16</span></div><div class="line">   <span class="keywordflow">case</span> 7 :</div><div class="line">      <span class="keywordflow">switch</span> (lineCoding-&gt;<a name="a18"></a><a class="code" href="struct_line_coding_structure.html#a0f726286e02df447d1ba9f20174226cf">bParityType</a>) {</div><div class="line">      <span class="keywordflow">case</span> 1:  UARTC1Value = <a name="a19"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga0204f696872c2e5f92413bb11d0170d1">UART_C1_PE_MASK</a>|<a name="a20"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga5a1c05b549b94de9232fbac665b3f584">UART_C1_PT_MASK</a>; <span class="keywordflow">break</span>; <span class="comment">// Odd</span></div><div class="line">      <span class="keywordflow">case</span> 2:  UARTC1Value = <a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga0204f696872c2e5f92413bb11d0170d1">UART_C1_PE_MASK</a>;                 <span class="keywordflow">break</span>; <span class="comment">// Even</span></div><div class="line">      }</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   <span class="keywordflow">case</span> 8 :</div><div class="line">      UARTC1Value = <a name="a21"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gabbe5c7cb60072d535d068446606414c5">UART_C1_M_MASK</a>; <span class="comment">// 9-data or 8-data+parity</span></div><div class="line">      <span class="keywordflow">switch</span> (lineCoding-&gt;<a class="code" href="struct_line_coding_structure.html#a0f726286e02df447d1ba9f20174226cf">bParityType</a>) {</div><div class="line">      <span class="keywordflow">case</span> 0:  UARTC1Value  = 0;                               <span class="keywordflow">break</span>; <span class="comment">// None</span></div><div class="line">      <span class="keywordflow">case</span> 1:  UARTC1Value |= <a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga0204f696872c2e5f92413bb11d0170d1">UART_C1_PE_MASK</a>|<a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga5a1c05b549b94de9232fbac665b3f584">UART_C1_PT_MASK</a>; <span class="keywordflow">break</span>; <span class="comment">// Odd</span></div><div class="line">      <span class="keywordflow">case</span> 2:  UARTC1Value |= <a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga0204f696872c2e5f92413bb11d0170d1">UART_C1_PE_MASK</a>;                 <span class="keywordflow">break</span>; <span class="comment">// Even</span></div><div class="line">      <span class="keywordflow">case</span> 3:  UARTC3Value  = <a name="a22"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gaec915ed2882cf21feb385399e44b5a9b">UART_C3_T8_MASK</a>;                 <span class="keywordflow">break</span>; <span class="comment">// Mark</span></div><div class="line">      <span class="keywordflow">case</span> 4:                                                  <span class="keywordflow">break</span>; <span class="comment">// Space</span></div><div class="line">      }</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   default :</div><div class="line">      <span class="keywordflow">break</span>;</div><div class="line">   }</div><div class="line">   UartInfo::uart-&gt;C1 = UARTC1Value;</div><div class="line">   UartInfo::uart-&gt;C2 =</div><div class="line">         <a name="a23"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gaa2cb31ebff38bb70191a8852eb0216aa">UART_C2_RIE_MASK</a>| <span class="comment">// Receive interrupts (Transmit interrupts enabled when data written)</span></div><div class="line">         <a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga181a8e8fd0f780d45f1bff7c76836fe5">UART_C2_RE_MASK</a>|  <span class="comment">// Receiver enable</span></div><div class="line">         <a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga3ac02e42b689641339aadf50ba868492">UART_C2_TE_MASK</a>;  <span class="comment">// Transmitter enable</span></div><div class="line">   UartInfo::uart-&gt;C3 = UARTC3Value|</div><div class="line">         <a name="a24"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gaf165d0ae5fd464a2ec367e29d1dedcb2">UART_C3_FEIE_MASK</a>| <span class="comment">// Framing error</span></div><div class="line">         <a name="a25"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga1e485aea10f0176919ae060d0ee1d709">UART_C3_NEIE_MASK</a>| <span class="comment">// Noise error</span></div><div class="line">         <a name="a26"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga85999d87eca30c526580b0d060f2aff5">UART_C3_ORIE_MASK</a>| <span class="comment">// Overrun error</span></div><div class="line">         <a name="a27"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gadf1ad2301848b5812b84658d02cc2006">UART_C3_PEIE_MASK</a>; <span class="comment">// Parity error</span></div><div class="line"></div><div class="line">   <a name="a28"></a><a class="code" href="group___c_m_s_i_s___core___n_v_i_c_functions.html#ga3349f2e3580d7ce22d6530b7294e5921">NVIC_EnableIRQ</a>(UartInfo::irqNums[0]);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  Get CDC communication characteristics\n</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  @return lineCodingStructure - Static structure describing current settings</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a> <span class="keyword">const</span> *CDC_Interface::getLineCoding() {</div><div class="line">   <span class="keywordflow">return</span> &amp;currentLineCoding;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  Send CDC break\n</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param length Length of break in milliseconds (see note)\n</span></div><div class="line"><span class="comment"> *  - 0x0000 =&gt; End BREAK</span></div><div class="line"><span class="comment"> *  - 0xFFFF =&gt; Start indefinite BREAK</span></div><div class="line"><span class="comment"> *  - else   =&gt; Send a break of 10 chars</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> * @note - only partially implemented</span></div><div class="line"><span class="comment"> *       - breaks are sent after currently queued characters</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> CDC_Interface::sendBreak(uint16_t length) {</div><div class="line">   <span class="keywordflow">if</span> (length == 0xFFFF) {</div><div class="line">      <span class="comment">// Send indefinite BREAKs</span></div><div class="line">      breakCount = 0xFF;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (length == 0x0) {</div><div class="line">      <span class="comment">// Stop sending BREAKs</span></div><div class="line">      breakCount = 0x00;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">else</span> {</div><div class="line">      <span class="comment">// Queue a series of BREAKs</span></div><div class="line">      breakCount = 10;</div><div class="line">   }</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  Set CDC Line values</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param value - Describes desired settings</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> CDC_Interface::setControlLineState(uint8_t value) {</div><div class="line">   (void) value;</div><div class="line">   <span class="comment">// Not implemented as no control signals</span></div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Interrupt callback for UART</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> uartCallback(uint8_t status) {</div><div class="line">   <span class="keywordflow">if</span> (status&amp;<a name="a29"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gab62f7e1b8548b5bbe5686f31c4beae61">UART_S1_RDRF_MASK</a>) {</div><div class="line">      <span class="comment">// Transfers a char from the UART_D to CDC-IN queue</span></div><div class="line">      inQueue.<a class="code" href="class_queue.html#a2610b19a7fc31d94db559fa3c933622e">enQueue</a>(UartInfo::uart-&gt;D);</div><div class="line">      <span class="keywordflow">if</span> (!inCallback()) {</div><div class="line">         cdcStatus |= <a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gac8102fb901477551dcc8505b3afb5272">UART_S1_OR_MASK</a>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status&amp;<a name="a30"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#gaa7d30e83d1a7d0a544393186508a667e">UART_S1_TDRE_MASK</a>) {</div><div class="line">      <span class="comment">//  Transfer a char from the CDC-OUT queue to UART_D</span></div><div class="line">      <span class="keywordflow">if</span> (!outQueue.<a class="code" href="class_queue.html#a46339c85f72f5dc98fc11b34bf67b08a">isEmpty</a>()) {</div><div class="line">         UartInfo::uart-&gt;D = outQueue.<a class="code" href="class_queue.html#ab0a5488a4757115f4dd3e8ba1f550334">deQueue</a>(); <span class="comment">// Send the char</span></div><div class="line">      }</div><div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (breakCount &gt; 0) {</div><div class="line">         <span class="comment">// Send another BREAK &#39;char&#39;</span></div><div class="line">         UartInfo::uart-&gt;C2 |=  <a name="a31"></a><a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga8d243e5b3a3ece12bdeca818bacb15ee">UART_C2_SBK_MASK</a>;</div><div class="line">         UartInfo::uart-&gt;C2 &amp;= ~<a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga8d243e5b3a3ece12bdeca818bacb15ee">UART_C2_SBK_MASK</a>;</div><div class="line">         <span class="keywordflow">if</span> (breakCount != 0xFF) {</div><div class="line">            breakCount--;</div><div class="line">         }</div><div class="line">      }</div><div class="line">      <span class="keywordflow">else</span> {</div><div class="line">         <span class="comment">// No characters available</span></div><div class="line">         <span class="comment">// Disable further UART transmit interrupts</span></div><div class="line">         UartInfo::uart-&gt;C2 &amp;= ~<a class="code" href="group___u_a_r_t___register___masks___g_r_o_u_p.html#ga0b4f935e44fda4076d7c8964c9d1e409">UART_C2_TIE_MASK</a>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">else</span> {</div><div class="line">      <span class="comment">// Record and clear error status</span></div><div class="line">      cdcStatus |= status;</div><div class="line">      <span class="keywordflow">if</span> (UartInfo::statusNeedsWrite) {</div><div class="line">         <span class="comment">// Clear error flags</span></div><div class="line">         UartInfo::uart-&gt;S1 = 0xFF;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">else</span> {</div><div class="line">         <span class="comment">// Reading data clears flags</span></div><div class="line">         (void)UartInfo::uart-&gt;D;</div><div class="line">      }</div><div class="line">   }</div><div class="line">}</div><div class="line"></div><div class="line">}; <span class="comment">// end namespace USBDM</span></div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Aug 12 2017 08:54:36 for USBDM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
