<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USBDM: hmc5883l.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USBDM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">hmc5883l.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> ============================================================================</span></div><div class="line"><span class="comment"> * @file     hmc5883l.cpp</span></div><div class="line"><span class="comment"> * @brief    Interface for HMC5883L 3-axis magnetometer</span></div><div class="line"><span class="comment"> * @version  V4.11.1.70</span></div><div class="line"><span class="comment"> * @date     18 June 2015</span></div><div class="line"><span class="comment"> * @author   podonoghue</span></div><div class="line"><span class="comment"> ============================================================================</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;hmc5883l.h&quot;</span></div><div class="line"> <span class="comment">/*</span></div><div class="line"><span class="comment"> * *****************************</span></div><div class="line"><span class="comment"> * *** DO NOT EDIT THIS FILE ***</span></div><div class="line"><span class="comment"> * *****************************</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is generated automatically.</span></div><div class="line"><span class="comment"> * Any manual changes will be lost.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_u_s_b_d_m.html">USBDM</a>;</div><div class="line"></div><div class="line"><span class="keyword">enum</span> Mag_Addr {</div><div class="line">   <span class="comment">/*                            type  default  */</span></div><div class="line">   CRA_REG_M         = 0x00,  <span class="comment">/* rw    00010000 */</span></div><div class="line">   CRB_REG_M         = 0x01,  <span class="comment">/* rw    00100000 */</span></div><div class="line">   MR_REG_M          = 0x02,  <span class="comment">/* rw    00000011 */</span></div><div class="line">   OUT_X_H_M         = 0x03,  <span class="comment">/* r     -        */</span></div><div class="line">   OUT_X_L_M         = 0x04,  <span class="comment">/* r     -        */</span></div><div class="line">   OUT_Y_H_M         = 0x05,  <span class="comment">/* r     -        */</span></div><div class="line">   OUT_Y_L_M         = 0x06,  <span class="comment">/* r     -        */</span></div><div class="line">   OUT_Z_H_M         = 0x07,  <span class="comment">/* r     -        */</span></div><div class="line">   OUT_Z_L_M         = 0x08,  <span class="comment">/* r     -        */</span></div><div class="line">   SR_REG_Mg         = 0x09,  <span class="comment">/* r     00000000 */</span></div><div class="line">   IRA_REG_M         = 0x0A,  <span class="comment">/* r     01001000 */</span></div><div class="line">   IRB_REG_M         = 0x0B,  <span class="comment">/* r     00110100 */</span></div><div class="line">   IRC_REG_M         = 0x0C,  <span class="comment">/* r     00110011 */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="preprocessor">#define HMC5883L_SR_LOCK   (1&lt;&lt;1)   // Register values are locked when:</span></div><div class="line">   <span class="comment">//                               //  1. some, but not all of, the six data output registers have been read,</span></div><div class="line">   <span class="comment">//                               //  2. mode register has been read.</span></div><div class="line">   <span class="comment">//                               // Remains locked until:</span></div><div class="line">   <span class="comment">//                               //  1. all six result bytes have been read,</span></div><div class="line">   <span class="comment">//                               //  2. the mode register is changed,</span></div><div class="line">   <span class="comment">//                               //  3. the measurement configuration (CRA) is changed,</span></div><div class="line">   <span class="comment">//                               //  4. power is reset.</span></div><div class="line"><span class="preprocessor">#define HMC5883L_SR_RDY    (1&lt;&lt;0)   // Ready Bit.</span></div><div class="line">   <span class="comment">//                               // Set when data is written to all six data registers.</span></div><div class="line">   <span class="comment">//                               // Cleared when device initiates a write to the data output registers and</span></div><div class="line">   <span class="comment">//                               // after one or more of the data output registers are written to.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Constructor</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param i2c - I2C interface to use</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line">   HMC5883L::HMC5883L(<a name="_a0"></a><a class="code" href="class_u_s_b_d_m_1_1_i2c.html">USBDM::I2c</a> &amp;i2c) : i2c(i2c) {</div><div class="line"></div><div class="line">   <span class="comment">// Set default settings</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> uint8_t settings[] = {</div><div class="line">      CRA_REG_M,</div><div class="line">      craValue(MagAverages_8, MagBias_Normal, MagDataRate_1_5_Hz),</div><div class="line">      crbValue(MagRange_4_7),</div><div class="line">      MagMode_Sleep,</div><div class="line">   };</div><div class="line">   i2c.<a name="a1"></a><a class="code" href="class_u_s_b_d_m_1_1_i2c.html#afbbe957420e487d675063f6b47089f24">transmit</a>(magAddress, <span class="keyword">sizeof</span>(settings), settings);</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef DEBUG_BUILD</span></div><div class="line">   <span class="comment">// Read back - debug only</span></div><div class="line">   uint8_t confirm[3];</div><div class="line">   i2c.<a name="a2"></a><a class="code" href="class_u_s_b_d_m_1_1_i2c.html#abdceaaac3c61e61fe60a08bbd1fd4666">txRx</a>(magAddress, 1, settings, <span class="keyword">sizeof</span>(confirm), confirm);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Read ID from compass</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return ID value as 24-bit number (0x483433 for HMC5883L)</span></div><div class="line"><span class="comment"> */</span></div><div class="line">uint32_t HMC5883L::readID(<span class="keywordtype">void</span>) {</div><div class="line">   uint8_t values[] = {IRA_REG_M, 0x00, 0x00};</div><div class="line">   i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#abdceaaac3c61e61fe60a08bbd1fd4666">txRx</a>(magAddress, 1, <span class="keyword">sizeof</span>(values), values);</div><div class="line">   <span class="keywordflow">return</span> (values[0]&lt;&lt;16)|(values[1]&lt;&lt;8)|values[2];</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * Set compass gain and hence range on all channels</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param range                                      \n</span></div><div class="line"><span class="comment"> * G    Recommended   Gain        Resolution         \n</span></div><div class="line"><span class="comment"> * 321  Sensor Range  (LSB/Gauss) (mGauss/LSB)       \n</span></div><div class="line"><span class="comment"> * 000   +/- 0.88 Ga    1370        0.73             \n</span></div><div class="line"><span class="comment"> * 001   +/- 1.3  Ga    1090        0.92 (default)   \n</span></div><div class="line"><span class="comment"> * 010   +/- 1.9  Ga     820        1.22             \n</span></div><div class="line"><span class="comment"> * 011   +/- 2.5  Ga     660        1.52             \n</span></div><div class="line"><span class="comment"> * 100   +/- 4.0  Ga     440        2.27             \n</span></div><div class="line"><span class="comment"> * 101   +/- 4.7  Ga     390        2.56             \n</span></div><div class="line"><span class="comment"> * 110   +/- 5.6  Ga     330        3.03             \n</span></div><div class="line"><span class="comment"> * 111   +/- 8.1  Ga     230        4.35</span></div><div class="line"><span class="comment"> */</span></div><div class="line">   <span class="keywordtype">void</span> HMC5883L::setRange(MagRange range) {</div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> uint8_t controlRegB_Setting[] = {CRB_REG_M, crbValue(range)};</div><div class="line">   i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#afbbe957420e487d675063f6b47089f24">transmit</a>(magAddress, <span class="keyword">sizeof</span>(controlRegB_Setting), controlRegB_Setting);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Set Control register values</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @param cra - Use craValue() to construct</span></div><div class="line"><span class="comment">    * @param crb - Use crbValue() to construct</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">void</span> HMC5883L::setConfiguration(uint8_t cra, uint8_t crb) {</div><div class="line">   <span class="comment">// Set CRA &amp; CRB</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> uint8_t controlReg_Settings[] = {CRA_REG_M, cra, crb};</div><div class="line">   i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#afbbe957420e487d675063f6b47089f24">transmit</a>(magAddress, <span class="keyword">sizeof</span>(controlReg_Settings), controlReg_Settings);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Do a single triggered measurement of magnetic field</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param x - X intensity</span></div><div class="line"><span class="comment"> * @param y - Y intensity</span></div><div class="line"><span class="comment"> * @param z - Z intensity</span></div><div class="line"><span class="comment"> */</span></div><div class="line">   <span class="keywordtype">void</span> HMC5883L::doMeasurement(int16_t *x, int16_t *y, int16_t *z) {</div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> uint8_t modeReg_Setting[] = {MR_REG_M, MagMode_Single};</div><div class="line">   i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#afbbe957420e487d675063f6b47089f24">transmit</a>(magAddress, <span class="keyword">sizeof</span>(modeReg_Setting), modeReg_Setting);</div><div class="line"></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> uint8_t statusRegAddress[] = {SR_REG_Mg};</div><div class="line">   uint8_t status[1];</div><div class="line">   <span class="keywordflow">do</span> {</div><div class="line">      i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#abdceaaac3c61e61fe60a08bbd1fd4666">txRx</a>(magAddress, <span class="keyword">sizeof</span>(statusRegAddress), statusRegAddress, <span class="keyword">sizeof</span>(status), status);</div><div class="line">      } <span class="keywordflow">while</span> ((status[0]&amp;HMC5883L_SR_RDY) == 0);</div><div class="line"></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> uint8_t resultRegAddress[] = {OUT_X_H_M};</div><div class="line">   uint8_t values[6];</div><div class="line">   i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#abdceaaac3c61e61fe60a08bbd1fd4666">txRx</a>(magAddress, <span class="keyword">sizeof</span>(resultRegAddress), resultRegAddress, <span class="keyword">sizeof</span>(values), values);</div><div class="line"></div><div class="line">   *x = (values[0]&lt;&lt;8)+values[1];</div><div class="line">   *z = (values[2]&lt;&lt;8)+values[3];</div><div class="line">   *y = (values[4]&lt;&lt;8)+values[5];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//   void HMC5883L::calibrate() {</span></div><div class="line"><span class="comment">//      const uint8_t cra[]     = {CRA_REG_M,  0x71};</span></div><div class="line"><span class="comment">//      i2c.transmit(magAddress,  sizeof(cra), cra);</span></div><div class="line"><span class="comment">//      const uint8_t crb[]     = {CRB_REG_M,  0xA0};</span></div><div class="line"><span class="comment">//      i2c.transmit(magAddress,  sizeof(cra), crb);</span></div><div class="line"><span class="comment">//      const uint8_t mode[]    = {MR_REG_M,   0x00};</span></div><div class="line"><span class="comment">//      i2c.transmit(magAddress, sizeof(cra), mode);</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//      uint8_t status[1];</span></div><div class="line"><span class="comment">//      static const uint8_t statusRegAddress[] = {SR_REG_Mg};</span></div><div class="line"><span class="comment">//      do {</span></div><div class="line"><span class="comment">//         i2c.txRx(magAddress, sizeof(statusRegAddress), statusRegAddress, sizeof(status), status);</span></div><div class="line"><span class="comment">//      } while ((status[0]&amp;HMC5883L_SR_RDY) == 0);</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//      static const uint8_t resultRegAddress[] = {OUT_X_H_M};</span></div><div class="line"><span class="comment">//      uint8_t values[6];</span></div><div class="line"><span class="comment">//      i2c.txRx(magAddress, sizeof(resultRegAddress), resultRegAddress, sizeof(values), values);</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//      int x = (int16_t)((values[0]&lt;&lt;8)+values[1]);</span></div><div class="line"><span class="comment">//      int z = (int16_t)((values[2]&lt;&lt;8)+values[3]);</span></div><div class="line"><span class="comment">//      int y = (int16_t)((values[4]&lt;&lt;8)+values[5]);</span></div><div class="line"><span class="comment">//   }</span></div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Aug 21 2017 07:45:21 for USBDM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
