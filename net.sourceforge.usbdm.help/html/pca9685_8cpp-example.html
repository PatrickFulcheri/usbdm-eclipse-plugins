<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USBDM: pca9685.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USBDM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">pca9685.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @file pca9685.cpp</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  Created on: 12/12/2015</span></div><div class="line"><span class="comment"> *      Author: podonoghue</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#include &quot;pca9685.h&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div><div class="line"> <span class="comment">/*</span></div><div class="line"><span class="comment"> * *****************************</span></div><div class="line"><span class="comment"> * *** DO NOT EDIT THIS FILE ***</span></div><div class="line"><span class="comment"> * *****************************</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is generated automatically.</span></div><div class="line"><span class="comment"> * Any manual changes will be lost.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespace_u_s_b_d_m.html">USBDM</a> {</div><div class="line"></div><div class="line">constexpr uint32_t I2C_SWRST_ADDRESS      =  (0x00&lt;&lt;1); <span class="comment">// General I2C Software reset address</span></div><div class="line"></div><div class="line"><span class="comment">//============== PCA9685 register addresses</span></div><div class="line">constexpr uint32_t PCA9685_RESET          =  (0x06);   <span class="comment">// Used in conjunction with I2C_SWRST_ADDR</span></div><div class="line"></div><div class="line">constexpr uint32_t PCA9685_MODE1          =  (0x00);   <span class="comment">// READ/WRITE Mode register 1</span></div><div class="line">constexpr uint32_t PCA9685_MODE2          =  (0x01);   <span class="comment">// READ/WRITE Mode register 2</span></div><div class="line">constexpr uint32_t PCA9685_SUBADR1        =  (0x02);   <span class="comment">// READ/WRITE I2C-bus sub-address 1</span></div><div class="line">constexpr uint32_t PCA9685_SUBADR2        =  (0x03);   <span class="comment">// READ/WRITE I2C-bus sub-address 2</span></div><div class="line">constexpr uint32_t PCA9685_SUBADR3        =  (0x04);   <span class="comment">// READ/WRITE I2C-bus sub-address 3</span></div><div class="line">constexpr uint32_t PCA9685_ALLCALLADR     =  (0x05);   <span class="comment">// READ/WRITE OUT All Call I2C-bus address</span></div><div class="line">constexpr uint32_t PCA9685_OUT_START      =  (0x06);   <span class="comment">// READ/WRITE OUT0  output and brightness control byte 0</span></div><div class="line"><span class="comment">//constexpr uint32_t PCA9685_OUT0_ON_L       = (0x06);   // READ/WRITE OUT0  output and brightness control byte 0</span></div><div class="line"><span class="comment">//constexpr uint32_t PCA9685_OUT0_ON_H       = (0x07);   // READ/WRITE OUT0  output and brightness control byte 1</span></div><div class="line"><span class="comment">//constexpr uint32_t PCA9685_OUT0_OFF_L      = (0x08);   // READ/WRITE OUT0  output and brightness control byte 2</span></div><div class="line"><span class="comment">//constexpr uint32_t PCA9685_OUT0_OFF_H      = (0x09);   // READ/WRITE OUT0  output and brightness control byte 3</span></div><div class="line"><span class="comment">//...</span></div><div class="line">constexpr uint32_t PCA9685_ALL_OUT_ON_L   =  (0xFA);   <span class="comment">// READ 0/WRITE load all the OUTn_ON  registers, byte 0</span></div><div class="line">constexpr uint32_t PCA9685_ALL_OUT_ON_H   =  (0xFB);   <span class="comment">// READ 0/WRITE load all the OUTn_ON  registers, byte 1</span></div><div class="line">constexpr uint32_t PCA9685_ALL_OUT_OFF_L  =  (0xFC);   <span class="comment">// READ 0/WRITE load all the OUTn_OFF registers, byte 2</span></div><div class="line">constexpr uint32_t PCA9685_ALL_OUT_OFF_H  =  (0xFD);   <span class="comment">// READ 0/WRITE load all the OUTn_OFF registers, byte 3</span></div><div class="line"></div><div class="line">constexpr uint32_t PCA9685_PRE_SCALE      =  (0xFE);   <span class="comment">// READ/WRITE pre-scaler for output frequency</span></div><div class="line">constexpr uint32_t PCA9685_TestMode       =  (0xFF);   <span class="comment">// READ/WRITE defines the test mode to be entered</span></div><div class="line"></div><div class="line"><span class="comment">// Calculates base register address for pin register set</span></div><div class="line">constexpr <span class="keyword">inline</span> <span class="keywordtype">int</span> PCA9685_PIN_REG(<span class="keywordtype">int</span> pinNum) {</div><div class="line">   <span class="keywordflow">return</span> ((uint8_t)(PCA9685_OUT_START+4*(pinNum)));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// OUTx_ON_L</span></div><div class="line"><span class="comment">//             7:0 OUTx_ON count for OUTx, 8 LSBs</span></div><div class="line">constexpr uint32_t OUTx_ON_L_COUNT_MASK = (0xFF&lt;&lt;0);</div><div class="line"><span class="comment">// OUTx_ON_H</span></div><div class="line">constexpr uint32_t OUTx_ON_H_FULL_MASK  = (1&lt;&lt;4);</div><div class="line">constexpr uint32_t OUTx_ON_H_COUNT_MASK = (0xF&lt;&lt;0);</div><div class="line"><span class="comment">//               4 OUTx full ON</span></div><div class="line"><span class="comment">//             3:0 OUTx_ON count for OUTx, 4 MSBs</span></div><div class="line"><span class="comment">// OUTx_OFF_L</span></div><div class="line">constexpr uint32_t OUTx_OFF_L_COUNT_MASK = (0xFF&lt;&lt;0);</div><div class="line"><span class="comment">//             7:0 OUTx_OFF count for OUTx, 8 LSBs</span></div><div class="line"><span class="comment">// OUTx_OFF_H</span></div><div class="line">constexpr uint32_t OUTx_OFF_H_FULL_MASK  = (1&lt;&lt;4);</div><div class="line">constexpr uint32_t OUTx_OFF_H_COUNT_MASK = (0xF&lt;&lt;0);</div><div class="line"><span class="comment">//               4 OUTx full OFF</span></div><div class="line"><span class="comment">//             3:0 OUTx_OFF count for OUTx, 4 MSBs</span></div><div class="line"></div><div class="line">constexpr uint32_t ALL_CALL_ADDDRESS  =  (0xE0);</div><div class="line"></div><div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> assert_helper( <span class="keywordtype">bool</span> test ) {</div><div class="line">  assert(test);</div><div class="line">}</div><div class="line"><span class="keyword">inline</span> constexpr <span class="keywordtype">bool</span> constexpr_assert( <span class="keywordtype">bool</span> test ) {</div><div class="line">  <span class="keywordflow">return</span> test?<span class="keyword">true</span>:(assert_helper(test),<span class="keyword">false</span>);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Constructor with default values</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param deviceAddress    Device I2C address</span></div><div class="line"><span class="comment"> * @param prescaleValue    Prescale value for the internal clock</span></div><div class="line"><span class="comment"> * @param mode1Value       Mode register 1 value</span></div><div class="line"><span class="comment"> * @param mode2Value       Mode Register 2 value</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line">PCA9685::PCA9685(I2c &amp;i2c, uint8_t deviceAddress, uint8_t prescaleValue, uint8_t mode1Value, uint8_t mode2Value)</div><div class="line">  : i2c(i2c), slaveAddress(deviceAddress) {</div><div class="line"></div><div class="line">   assert((PCA9685_DEFAULT_OSC_PRESCALE &amp; ~0xFFU) == 0); <span class="comment">// Check if OSC_PRESCALE is too large</span></div><div class="line"></div><div class="line"><span class="comment">//   uint8_t resetdata[] = {PCA9685_RESET};</span></div><div class="line"><span class="comment">//   i2c_transmit(I2C_SWRST_ADDRESS, resetdata, sizeof(resetdata));</span></div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">const</span> uint8_t mode1data[] = {</div><div class="line">       <span class="comment">/* register address */</span>   PCA9685_MODE1,</div><div class="line">       <span class="comment">/* mode1            */</span>   mode1Value,</div><div class="line">       <span class="comment">/* mode2            */</span>   mode2Value,</div><div class="line">       <span class="comment">/* subaddr1         */</span>   0,</div><div class="line">       <span class="comment">/* subaddr2         */</span>   0,</div><div class="line">       <span class="comment">/* subaddr3         */</span>   0,</div><div class="line">       <span class="comment">/* all call address */</span>   ALL_CALL_ADDDRESS</div><div class="line">   };</div><div class="line">   i2c.transmit(slaveAddress, <span class="keyword">sizeof</span>(mode1data), mode1data);</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">const</span> uint8_t prescaleData[] = {</div><div class="line">      PCA9685_PRE_SCALE,</div><div class="line">      prescaleValue   <span class="comment">// Prescale value for clock</span></div><div class="line">   };</div><div class="line">   i2c.transmit(slaveAddress, <span class="keyword">sizeof</span>(prescaleData), prescaleData);</div><div class="line">   <span class="comment">// All outputs off</span></div><div class="line">   allHigh();</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Set all outputs high</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> PCA9685::allHigh(<span class="keywordtype">void</span>) {</div><div class="line">   <span class="keyword">const</span> uint8_t data[] = {</div><div class="line">      <span class="comment">/* register */</span> (uint8_t) PCA9685_ALL_OUT_ON_L,</div><div class="line">      <span class="comment">/* onLow    */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* onHigh   */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* offLow   */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* offHigh  */</span> (uint8_t) OUTx_OFF_H_FULL_MASK,</div><div class="line">   };</div><div class="line">   i2c.transmit(ALL_CALL_ADDDRESS, <span class="keyword">sizeof</span>(data), data);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Set all outputs low</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> PCA9685::allLow(<span class="keywordtype">void</span>) {</div><div class="line">   <span class="keyword">const</span> uint8_t data[] = {</div><div class="line">      <span class="comment">/* register */</span> (uint8_t) PCA9685_ALL_OUT_ON_L,</div><div class="line">      <span class="comment">/* onLow    */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* onHigh   */</span> (uint8_t) OUTx_ON_H_FULL_MASK,</div><div class="line">      <span class="comment">/* offLow   */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* offHigh  */</span> (uint8_t) 0,</div><div class="line">   };</div><div class="line">   i2c.transmit(ALL_CALL_ADDDRESS, <span class="keyword">sizeof</span>(data), data);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Sets the dutyCycle of the given pin</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param pinNum     Pin to modify</span></div><div class="line"><span class="comment"> * @param dutyCycle  Duty-cycle to set. Expressed as a value [0..4095]</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> PCA9685::set_pin_pwm(<span class="keywordtype">unsigned</span> pinNum, <span class="keywordtype">unsigned</span> dutyCycle) {</div><div class="line">   <span class="keywordflow">if</span> (dutyCycle&gt;MAX_PWM) {</div><div class="line">      dutyCycle = MAX_PWM;</div><div class="line">   }</div><div class="line">   <span class="keyword">const</span> uint16_t onCount  = 0;</div><div class="line">   <span class="keyword">const</span> uint16_t offCount = dutyCycle;</div><div class="line">   <span class="keyword">const</span> uint8_t data[] = {</div><div class="line">      <span class="comment">/* register */</span> (uint8_t) PCA9685_PIN_REG(pinNum),</div><div class="line">      <span class="comment">/* onLow    */</span> (uint8_t) onCount,</div><div class="line">      <span class="comment">/* onHigh   */</span> (uint8_t) ((onCount&gt;&gt;8)&amp;OUTx_ON_H_COUNT_MASK),</div><div class="line">      <span class="comment">/* offLow   */</span> (uint8_t) offCount,</div><div class="line">      <span class="comment">/* offHigh  */</span> (uint8_t) ((offCount&gt;&gt;8)&amp;OUTx_OFF_H_COUNT_MASK),</div><div class="line">   };</div><div class="line">   i2c.transmit(slaveAddress, <span class="keyword">sizeof</span>(data), data);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Set given pin low</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param pinNum Pin to change</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> PCA9685::set_pin_low(<span class="keywordtype">unsigned</span> pinNum) {</div><div class="line">   <span class="keyword">const</span> uint8_t data[] = {</div><div class="line">      <span class="comment">/* register */</span> (uint8_t) PCA9685_PIN_REG(pinNum),</div><div class="line">      <span class="comment">/* onLow    */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* onHigh   */</span> (uint8_t) OUTx_ON_H_FULL_MASK,</div><div class="line">      <span class="comment">/* offLow   */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* offHigh  */</span> (uint8_t) 0,</div><div class="line">   };</div><div class="line">   i2c.transmit(slaveAddress, <span class="keyword">sizeof</span>(data), data);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Set given pin high</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param pinNum Pin to change</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> PCA9685::set_pin_high(<span class="keywordtype">unsigned</span> pinNum) {</div><div class="line">   <span class="keyword">const</span> uint8_t data[] = {</div><div class="line">      <span class="comment">/* register */</span> (uint8_t) PCA9685_PIN_REG(pinNum),</div><div class="line">      <span class="comment">/* onLow    */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* onHigh   */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* offLow   */</span> (uint8_t) 0,</div><div class="line">      <span class="comment">/* offHigh  */</span> (uint8_t) OUTx_OFF_H_FULL_MASK,</div><div class="line">   };</div><div class="line">   i2c.transmit(slaveAddress, <span class="keyword">sizeof</span>(data), data);</div><div class="line">}</div><div class="line"></div><div class="line">} <span class="comment">// End namespace USBDM</span></div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Aug 12 2017 08:54:36 for USBDM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
