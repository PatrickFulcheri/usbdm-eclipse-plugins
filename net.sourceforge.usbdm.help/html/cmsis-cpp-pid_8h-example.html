<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USBDM: cmsis-cpp-pid.h</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USBDM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">cmsis-cpp-pid.h</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @file    pid.h</span></div><div class="line"><span class="comment"> * @brief   PID Controller using CMSIS TimerClass</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  Created on: 10 Jul 2016</span></div><div class="line"><span class="comment"> *      Author: podonoghue</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifndef PROJECT_HEADERS_PID_H_</span></div><div class="line"><span class="preprocessor">#define PROJECT_HEADERS_PID_H_</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="cmsis_8h.html">cmsis.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;pid.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>Pid {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">   <span class="keyword">typedef</span> <span class="keywordtype">float</span>  InFunction();</div><div class="line">   <span class="keyword">typedef</span> <span class="keywordtype">void</span>   OutFunction(<span class="keywordtype">float</span>);</div><div class="line">};</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * PID Controller</span></div><div class="line"><span class="comment"> * Makes use of CMSIS TimerClass</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * These template parameters connect the PID controller to the input and output functions</span></div><div class="line"><span class="comment"> * @tparam inputFn      Input function  - used to obtain value of system state</span></div><div class="line"><span class="comment"> * @tparam outputFn     Output function - used to control the output variable</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">template</span>&lt;P<span class="keywordtype">id</span>::InFunction inputFn, P<span class="keywordtype">id</span>::OutFunction outputFn&gt;</div><div class="line"><span class="keyword">class </span>Pid_T : <span class="keyword">private</span> Pid, <span class="keyword">private</span> <a name="_a0"></a><a class="code" href="class_c_m_s_i_s_1_1_timer_class.html">CMSIS::TimerClass</a>&lt;osTimerPeriodic&gt; {</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">double</span> interval;     <span class="comment">//! Interval for sampling</span></div><div class="line"><span class="comment"></span>   <span class="keyword">const</span> <span class="keywordtype">double</span> outMin;       <span class="comment">//! Minimum limit for output</span></div><div class="line"><span class="comment"></span>   <span class="keyword">const</span> <span class="keywordtype">double</span> outMax;       <span class="comment">//! Maximum limit for output</span></div><div class="line"><span class="comment"></span></div><div class="line">   <span class="keywordtype">double</span> kp;                 <span class="comment">//! Proportional Tuning Parameter</span></div><div class="line"><span class="comment"></span>   <span class="keywordtype">double</span> ki;                 <span class="comment">//! Integral Tuning Parameter</span></div><div class="line"><span class="comment"></span>   <span class="keywordtype">double</span> kd;                 <span class="comment">//! Derivative Tuning Parameter</span></div><div class="line"><span class="comment"></span></div><div class="line">   <span class="keywordtype">bool</span>   enabled;            <span class="comment">//! Enable for controller</span></div><div class="line"><span class="comment"></span></div><div class="line">   <span class="keywordtype">double</span> integral;           <span class="comment">//! Integral accumulation term</span></div><div class="line"><span class="comment"></span></div><div class="line">   <span class="keywordtype">double</span> lastInput;          <span class="comment">//! Last input sample</span></div><div class="line"><span class="comment"></span>   <span class="keywordtype">double</span> currentInput;       <span class="comment">//! Current input sample</span></div><div class="line"><span class="comment"></span>   <span class="keywordtype">double</span> currentOutput;      <span class="comment">//! Current output</span></div><div class="line"><span class="comment"></span>   <span class="keywordtype">double</span> setpoint;           <span class="comment">//! Set-point for controller</span></div><div class="line"><span class="comment"></span>   <span class="keywordtype">double</span> currentError;       <span class="comment">//! Current error calculation</span></div><div class="line"><span class="comment"></span></div><div class="line">   <span class="keywordtype">unsigned</span> tickCount = 0;    <span class="comment">//! Time in ticks since last enabled</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keyword">public</span>:<span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Constructor</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @param[in] Kp          Initial proportional constant</span></div><div class="line"><span class="comment">    * @param[in] Ki          Initial integral constant</span></div><div class="line"><span class="comment">    * @param[in] Kd          Initial differential constant</span></div><div class="line"><span class="comment">    * @param[in] interval    Sample interval for controller</span></div><div class="line"><span class="comment">    * @param[in] outMin      Minimum value of output variable</span></div><div class="line"><span class="comment">    * @param[in] outMax      Maximum value of output variable</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   Pid_T(<span class="keywordtype">double</span> Kp, <span class="keywordtype">double</span> Ki, <span class="keywordtype">double</span> Kd, <span class="keywordtype">double</span> interval, <span class="keywordtype">double</span> outMin, <span class="keywordtype">double</span> outMax) :</div><div class="line">      interval(interval), outMin(outMin), outMax(outMax), enabled(<span class="keyword">false</span>) {</div><div class="line">      setTunings(Kp, Ki, Kd);</div><div class="line">      create();</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">   * Destructor</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">virtual</span> ~Pid_T() {</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Enable controller\n</span></div><div class="line"><span class="comment">    * Note: Controller is re-initialised when enabled</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @param[in] enable True to enable</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">void</span> enable(<span class="keywordtype">bool</span> enable = <span class="keyword">true</span>) {</div><div class="line">      <span class="keywordflow">if</span> (enable) {</div><div class="line">         <span class="keywordflow">if</span> (!enabled) {</div><div class="line">            <span class="comment">// Just enabled</span></div><div class="line">            currentInput = inputFn();</div><div class="line">            integral     = 0; <span class="comment">//currentOutput;</span></div><div class="line">            tickCount    = 0;</div><div class="line">            start(interval);</div><div class="line">         }</div><div class="line">      }</div><div class="line">      <span class="keywordflow">else</span> {</div><div class="line">         stop();</div><div class="line">      }</div><div class="line">      enabled = enable;</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Indicates if the controller is enabled</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return True =&gt; enabled</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">bool</span> isEnabled() {</div><div class="line">      <span class="keywordflow">return</span> enabled;</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Get number of ticks since last enabled</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return Number of ticks</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">unsigned</span> getTicks() {</div><div class="line">      <span class="keywordflow">return</span> tickCount;</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Get number of seconds since last enabled</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return Elapsed time</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">double</span> getElapsedTime() {</div><div class="line">      <span class="keywordflow">return</span> (tickCount*interval);</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Change controller tuning</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @param[in] Kp Proportional constant</span></div><div class="line"><span class="comment">    * @param[in] Ki Integral constant</span></div><div class="line"><span class="comment">    * @param[in] Kd Differential constant</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">void</span> setTunings(<span class="keywordtype">double</span> Kp, <span class="keywordtype">double</span> Ki, <span class="keywordtype">double</span> Kd) {</div><div class="line">      <span class="keywordflow">if</span> ((Kp&lt;0) || (Ki&lt;0) || (Kd&lt;0)) {</div><div class="line">         USBDM::setAndCheckErrorCode(<a name="a1"></a><a class="code" href="namespace_u_s_b_d_m.html#af5406ca776612b2687e916fb194ffd26a6544f386d99ec39474a4e446557f586b">USBDM::E_ILLEGAL_PARAM</a>);</div><div class="line">      }</div><div class="line">      kp = Kp;</div><div class="line">      ki = Ki * interval;</div><div class="line">      kd = Kd / interval;</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Change set-point of controller</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @param[in] value Value to set</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">void</span> setSetpoint(<span class="keywordtype">double</span> value) {</div><div class="line">      setpoint = value;</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Get setpoint of controller</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return Current setpoint</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">double</span> getSetpoint() {</div><div class="line">      <span class="keywordflow">return</span> setpoint;</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Get input of controller</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return Last input sample</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">double</span> getInput() {</div><div class="line">      <span class="keywordflow">return</span> currentInput;</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Get setpoint of controller</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return Last output sample</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">double</span> getOutput() {</div><div class="line">      <span class="keywordflow">return</span> currentOutput;</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Get error of controller</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return Last error calculation</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">double</span> <a name="a2"></a><a class="code" href="namespace_u_s_b_d_m.html#a18a94c6aa906dbe91381100cb5d9a815">getError</a>() {</div><div class="line">      <span class="keywordflow">return</span> currentError;</div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Get proportional control factor</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return factor as double</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">double</span> getKp() {</div><div class="line">      <span class="keywordflow">return</span>  kp;</div><div class="line">   }<span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Get integral control factor</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return factor as double</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">double</span> getKi() {</div><div class="line">      <span class="keywordflow">return</span>  ki/interval;</div><div class="line">   }<span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Get differential control factor</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * @return factor as double</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">double</span> getKd() {</div><div class="line">      <span class="keywordflow">return</span>  kd*interval;</div><div class="line">   }</div><div class="line"></div><div class="line"><span class="keyword">private</span>:<span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Main PID calculation</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * Executed at \ref interval by Timer callback</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keywordtype">void</span> callback()<span class="keyword"> override </span>{</div><div class="line">      <span class="keywordflow">if</span>(!enabled) {</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      tickCount++;</div><div class="line"></div><div class="line">      <span class="comment">// Update input samples &amp; error</span></div><div class="line">      lastInput    = currentInput;</div><div class="line">      currentInput = inputFn();</div><div class="line">      currentError = setpoint - currentInput;</div><div class="line"></div><div class="line">      integral += (ki * currentError);</div><div class="line">      <span class="keywordflow">if</span>(integral &gt; outMax) {</div><div class="line">         integral = outMax;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(integral &lt; outMin) {</div><div class="line">         integral = outMin;</div><div class="line">      }</div><div class="line">      <span class="keywordtype">double</span> deltaInput = (currentInput - lastInput);</div><div class="line"></div><div class="line">      currentOutput = kp * currentError + integral - kd * deltaInput;</div><div class="line">      <span class="keywordflow">if</span>(currentOutput &gt; outMax) {</div><div class="line">         currentOutput = outMax;</div><div class="line">      }</div><div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span>(currentOutput &lt; outMin) {</div><div class="line">         currentOutput = outMin;</div><div class="line">      }</div><div class="line">      <span class="comment">// Update output</span></div><div class="line">      outputFn(currentOutput);</div><div class="line">   }</div><div class="line"></div><div class="line">};</div><div class="line"></div><div class="line"><span class="preprocessor">#endif // PROJECT_HEADERS_PID_H_</span></div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Aug 12 2017 08:54:36 for USBDM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
