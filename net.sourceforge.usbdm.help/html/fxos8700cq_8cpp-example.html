<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USBDM: fxos8700cq.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USBDM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">fxos8700cq.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> ============================================================================</span></div><div class="line"><span class="comment"> * @file   fxos8700cq.cpp</span></div><div class="line"><span class="comment"> * @brief  FXOS8700 Accelerometer/Magnetometer interface</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  Created on: 10/6/2016</span></div><div class="line"><span class="comment"> *      Author: podonoghue</span></div><div class="line"><span class="comment"> ============================================================================</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#include &quot;fxos8700cq.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="delay_8h.html">delay.h</a>&quot;</span></div><div class="line"> <span class="comment">/*</span></div><div class="line"><span class="comment"> * *****************************</span></div><div class="line"><span class="comment"> * *** DO NOT EDIT THIS FILE ***</span></div><div class="line"><span class="comment"> * *****************************</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is generated automatically.</span></div><div class="line"><span class="comment"> * Any manual changes will be lost.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_u_s_b_d_m.html">USBDM</a>;</div><div class="line"></div><div class="line"><span class="comment">// Accelerometer registers</span></div><div class="line"><span class="keyword">enum</span> {</div><div class="line">   STATUS,</div><div class="line">   F_STATUS = STATUS,</div><div class="line">   OUT_X_MSB,</div><div class="line">   OUT_X_LSB,</div><div class="line">   OUT_Y_MSB,</div><div class="line">   OUT_Y_LSB,</div><div class="line">   OUT_Z_MSB,</div><div class="line">   OUT_Z_LSB,</div><div class="line">   Reservedx07,</div><div class="line">   Reservedx08,</div><div class="line">   F_SETUP,</div><div class="line">   TRIG_CFG,</div><div class="line">   SYSMOD,</div><div class="line">   INT_SOURCE,</div><div class="line">   WHO_AM_I,</div><div class="line">   XYZ_DATA_CFG,</div><div class="line">   HP_FILTER_CUTOFF,</div><div class="line">   PL_STATUS,</div><div class="line">   PL_CFG,</div><div class="line">   PL_COUNT,</div><div class="line">   PL_BF_ZCOMP,</div><div class="line">   P_L_THS_REG,</div><div class="line">   A_FFMT_CFG,</div><div class="line">   A_FFMT_SRC,</div><div class="line">   A_FFMT_THS,</div><div class="line">   A_FFMT_COUNT,</div><div class="line">   reservedx19,</div><div class="line">   reservedx1A,</div><div class="line">   reservedx1B,</div><div class="line">   reservedx1C,</div><div class="line">   TRANSIENT_CFG,</div><div class="line">   TRANSIENT_SCR,</div><div class="line">   TRANSIENT_THS,</div><div class="line">   TRANSIENT_COUNT,</div><div class="line">   PULSE_CFG,</div><div class="line">   PULSE_SRC,</div><div class="line">   PULSE_THSX,</div><div class="line">   PULSE_THSY,</div><div class="line">   PULSE_THSZ,</div><div class="line">   PULSE_TMLT,</div><div class="line">   PULSE_LTCY,</div><div class="line">   PULSE_WIND,</div><div class="line">   ASLP_COUNT,</div><div class="line">   CTRL_REG1,</div><div class="line">   CTRL_REG2,</div><div class="line">   CTRL_REG3,</div><div class="line">   CTRL_REG4,</div><div class="line">   CTRL_REG5,</div><div class="line">   OFF_X,</div><div class="line">   OFF_Y,</div><div class="line">   OFF_Z,</div><div class="line"></div><div class="line">   <span class="comment">// Magnetometer registers (0x32 onwards)</span></div><div class="line">   M_DR_STATUS,</div><div class="line">   M_OUT_X_MSB,</div><div class="line">   M_OUT_X_LSB,</div><div class="line">   M_OUT_Y_MSB,</div><div class="line">   M_OUT_Y_LSB,</div><div class="line">   M_OUT_Z_MSB,</div><div class="line">   M_OUT_Z_LSB,</div><div class="line">   CMP_X_MSB,</div><div class="line">   CMP_X_LSB,</div><div class="line">   CMP_Y_MSB,</div><div class="line">   CMP_Y_LSB,</div><div class="line">   CMP_Z_MSB,</div><div class="line">   CMP_Z_LSB,</div><div class="line">   M_OFF_X_MSB,</div><div class="line">   M_OFF_X_LSB,</div><div class="line">   M_OFF_Y_MSB,</div><div class="line">   M_OFF_Y_LSB,</div><div class="line">   M_OFF_Z_MSB,</div><div class="line">   M_OFF_Z_LSB,</div><div class="line">   MAX_X_MSB,</div><div class="line">   MAX_X_LSB,</div><div class="line">   MAX_Y_MSB,</div><div class="line">   MAX_Y_LSB,</div><div class="line">   MAX_Z_MSB,</div><div class="line">   MAX_Z_LSB,</div><div class="line">   MIN_X_MSB,</div><div class="line">   MIN_X_LSB,</div><div class="line">   MIN_Y_MSB,</div><div class="line">   MIN_Y_LSB,</div><div class="line">   MIN_Z_MSB,</div><div class="line">   MIN_Z_LSB,</div><div class="line">   TEMP,</div><div class="line">   M_THS_CFG,</div><div class="line">   M_THS_SRC,</div><div class="line">   M_THS_X_MSB,</div><div class="line">   M_THS_X_LSB,</div><div class="line">   M_THS_Y_MSB,</div><div class="line">   M_THS_Y_LSB,</div><div class="line">   M_THS_Z_MSB,</div><div class="line">   M_THS_Z_LSB,</div><div class="line">   M_THS_COUNT,</div><div class="line">   M_CTRL_REG1,</div><div class="line">   M_CTRL_REG2,</div><div class="line">   M_CTRL_REG3,</div><div class="line">   M_INT_SRC,</div><div class="line">   A_VECM_CFG,</div><div class="line">   A_VECM_THS_MSB,</div><div class="line">   A_VECM_THS_LSB,</div><div class="line">   A_VECM_CNT,</div><div class="line">   A_VECM_INITX_MSB,</div><div class="line">   A_VECM_INITX_LSB,</div><div class="line">   A_VECM_INITY_MSB,</div><div class="line">   A_VECM_INITY_LSB,</div><div class="line">   A_VECM_INITZ_MSB,</div><div class="line">   A_VECM_INITZ_LSB,</div><div class="line">   M_VECM_CFG,</div><div class="line">   M_VECM_THS_MSB,</div><div class="line">   M_VECM_THS_LSB,</div><div class="line">   M_VECM_CNT,</div><div class="line">   M_VECM_INITX_MSB,</div><div class="line">   M_VECM_INITX_LSB,</div><div class="line">   M_VECM_INITY_MSB,</div><div class="line">   M_VECM_INITY_LSB,</div><div class="line">   M_VECM_INITZ_MSB,</div><div class="line">   M_VECM_INITZ_LSB,</div><div class="line">   A_FFMT_THS_X_MSB,</div><div class="line">   A_FFMT_THS_X_LSB,</div><div class="line">   A_FFMT_THS_Y_MSB,</div><div class="line">   A_FFMT_THS_Y_LSB,</div><div class="line">   A_FFMT_THS_Z_MSB,</div><div class="line">   A_FFMT_THS_Z_LSB,</div><div class="line">   Reservedx79,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Constructor</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param i2c  - The I2C interface to use</span></div><div class="line"><span class="comment"> * @param mode - Mode of operation (gain and filtering)</span></div><div class="line"><span class="comment"> */</span></div><div class="line">FXOS8700CQ::FXOS8700CQ(<a name="_a0"></a><a class="code" href="class_u_s_b_d_m_1_1_i2c.html">USBDM::I2c</a> &amp;i2c, AccelerometerMode mode) : i2c(i2c) {</div><div class="line">   failedInit = <span class="keyword">false</span>;</div><div class="line">   <span class="keywordflow">if</span> (readReg(WHO_AM_I) != WHO_AM_I_VALUE) {</div><div class="line">      failedInit = <span class="keyword">true</span>;</div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line">   reset();</div><div class="line"></div><div class="line">   writeReg(CTRL_REG3, 0x00);                                   <span class="comment">// INT0/1 active low, open drain</span></div><div class="line">   writeReg(CTRL_REG4, FXOS8700CQ_CTRL_REG4_INT_EN_DRDY_MASK);  <span class="comment">// Enable DRDY Interrupt</span></div><div class="line">   writeReg(CTRL_REG5, FXOS8700CQ_CTRL_REG5_INT_CFG_DRDY_MASK); <span class="comment">// Route DRDY to INT1 pin (0=&gt; INT2, 1=&gt; INT1)</span></div><div class="line"></div><div class="line">   writeReg(M_CTRL_REG2, FXOS8700CQ_M_CTRL_REG2_M_HYB_AUTOINC_MODE_MASK); <span class="comment">// Hybrid auto-increment</span></div><div class="line"></div><div class="line">   setAccelerometerMode(mode);</div><div class="line"></div><div class="line"><span class="comment">//   uint8_t buff[5] = {CTRL_REG1};</span></div><div class="line"><span class="comment">//   i2c.txRx(DEVICE_ADDRESS, buff, 1, sizeof(buff));</span></div><div class="line"><span class="comment">//   printf(&quot;FXOS8700CQ, ctrl = 0x%x,0x%x,0x%x,0x%x,0x%x\n&quot;, buff[0], buff[1], buff[2], buff[3], buff[4] );</span></div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Enable accelerometer and/or magnetometer</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param mode ACCEL_ONLY, MAG_ONLY or ACCEL_MAG</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::enable(Mode mode) {</div><div class="line">   writeReg(M_CTRL_REG1, FXOS8700CQ_M_CTRL_REG1_M_OS(7)|FXOS8700CQ_M_CTRL_REG1_M_HMS(mode));</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Read Accelerometer register</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param regNum  - Register number</span></div><div class="line"><span class="comment"> */</span></div><div class="line">uint8_t FXOS8700CQ::readReg(uint8_t regNum) {</div><div class="line">   uint8_t command[] = {regNum};</div><div class="line"></div><div class="line">   i2c.<a name="a1"></a><a class="code" href="class_u_s_b_d_m_1_1_i2c.html#abdceaaac3c61e61fe60a08bbd1fd4666">txRx</a>(DEVICE_ADDRESS, 1, <span class="keyword">sizeof</span>(command), command);</div><div class="line">   <span class="keywordflow">return</span> command[0];</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Write Accelerometer register</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param regNum  - Register number</span></div><div class="line"><span class="comment"> * @param value   - Value to write</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::writeReg(uint8_t regNum, uint8_t value) {</div><div class="line">   uint8_t command[] = {regNum, value};</div><div class="line"></div><div class="line">   i2c.<a name="a2"></a><a class="code" href="class_u_s_b_d_m_1_1_i2c.html#afbbe957420e487d675063f6b47089f24">transmit</a>(DEVICE_ADDRESS, <span class="keyword">sizeof</span>(command), command);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Reset Accelerometer</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::reset(<span class="keywordtype">void</span>) {</div><div class="line"></div><div class="line">   writeReg(CTRL_REG2, FXOS8700CQ_CTRL_REG2_RST_MASK);</div><div class="line"></div><div class="line">   <span class="comment">// Device is not accessible after RESET</span></div><div class="line">   <a name="a3"></a><a class="code" href="namespace_u_s_b_d_m.html#a2068aeafaaba7afea505bc0340865a45">waitUS</a>(1000);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Put accelerometer into Standby mode</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::standby() {</div><div class="line"></div><div class="line">   writeReg(CTRL_REG1, readReg(CTRL_REG1)&amp;~FXOS8700CQ_CTRL_REG1_ACTIVE_MASK);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Put accelerometer into Active mode</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::active() {</div><div class="line"></div><div class="line">   writeReg(CTRL_REG1, readReg(CTRL_REG1)|FXOS8700CQ_CTRL_REG1_ACTIVE_MASK);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Obtains measurements from the accelerometer</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param status  - Indicates status of x, y &amp; z measurements</span></div><div class="line"><span class="comment"> * @param x       - X axis value</span></div><div class="line"><span class="comment"> * @param y       - Y axis value</span></div><div class="line"><span class="comment"> * @param z       - Z axis value</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::readAccelerometerXYZ(<span class="keywordtype">int</span> *status, int16_t *x, int16_t *y, int16_t *z) {</div><div class="line">   uint8_t dataXYZ[7] = {STATUS};</div><div class="line"></div><div class="line">   <span class="comment">// Receive 7 registers (status, X-high, X-low, Y-high, Y-low, Z-high &amp; Z-low)</span></div><div class="line">   i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#abdceaaac3c61e61fe60a08bbd1fd4666">txRx</a>(DEVICE_ADDRESS, 1, <span class="keyword">sizeof</span>(dataXYZ), dataXYZ);</div><div class="line"></div><div class="line">   <span class="comment">// Unpack data and return</span></div><div class="line">   *status = dataXYZ[0];</div><div class="line">   *x = ((int16_t)((dataXYZ[1]&lt;&lt;8)+dataXYZ[2]))&gt;&gt;2;</div><div class="line">   *y = ((int16_t)((dataXYZ[3]&lt;&lt;8)+dataXYZ[4]))&gt;&gt;2;</div><div class="line">   *z = ((int16_t)((dataXYZ[5]&lt;&lt;8)+dataXYZ[6]))&gt;&gt;2;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Set accelerometer mode (gain and filtering)</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param mode - one of ACCEL_2Gmode etc.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::setAccelerometerMode(AccelerometerMode mode) {</div><div class="line">   <span class="comment">// Make inactive</span></div><div class="line">   writeReg(CTRL_REG1, 0x00);</div><div class="line"></div><div class="line">   <span class="comment">// Change mode</span></div><div class="line">   writeReg(XYZ_DATA_CFG, FXOS8700CQ_XYZ_DATA_CFG_FS(mode));</div><div class="line"></div><div class="line">   <span class="comment">// Make active etc</span></div><div class="line">   writeReg(CTRL_REG1,</div><div class="line">         FXOS8700CQ_CTRL_REG1_ASLP_RATE(0) | <span class="comment">/* 50 Hz auto-sleep rate */</span></div><div class="line">         FXOS8700CQ_CTRL_REG1_DR(2) |        <span class="comment">/* 200 Hz update rate    */</span></div><div class="line">         FXOS8700CQ_CTRL_REG1_ACTIVE_MASK);  <span class="comment">/* Active     */</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Obtains measurements from the Magnetometer</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param status  - Indicates status of x, y &amp; z measurements</span></div><div class="line"><span class="comment"> * @param x       - X axis value</span></div><div class="line"><span class="comment"> * @param y       - Y axis value</span></div><div class="line"><span class="comment"> * @param z       - Z axis value</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::readMagnetometerXYZ(<span class="keywordtype">int</span> *status, int16_t *x, int16_t *y, int16_t *z) {</div><div class="line">   uint8_t dataXYZ[7] = {M_DR_STATUS};</div><div class="line"></div><div class="line">   <span class="comment">// Receive 7 registers (status, X-high, X-low, Y-high, Y-low, Z-high &amp; Z-low)</span></div><div class="line">   i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#abdceaaac3c61e61fe60a08bbd1fd4666">txRx</a>(DEVICE_ADDRESS, 1, <span class="keyword">sizeof</span>(dataXYZ), dataXYZ);</div><div class="line"></div><div class="line">   <span class="comment">// Unpack data and return (data is sign extended)</span></div><div class="line">   *status = dataXYZ[0];</div><div class="line">   *x = ((dataXYZ[1]&lt;&lt;8)+dataXYZ[2]);</div><div class="line">   *y = ((dataXYZ[3]&lt;&lt;8)+dataXYZ[4]);</div><div class="line">   *z = ((dataXYZ[5]&lt;&lt;8)+dataXYZ[6]);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Set magnetometer mode (gain and filtering)</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param mode - one of 2Gmode etc.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::setMagnetometerMode(ControlReg2Mode mode) {</div><div class="line">   writeReg(M_CTRL_REG2, mode|FXOS8700CQ_M_CTRL_REG2_M_HYB_AUTOINC_MODE_MASK);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Obtains measurements from the Accelerometer &amp; Magnetometer</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param data  Reference to structure to contain values read</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::readAll(Data &amp;data) {</div><div class="line">   uint8_t dataXYZ[13] = {XYZ_DATA_CFG};</div><div class="line"></div><div class="line">   <span class="comment">// Receive 14 registers (accelerometerStatus, X-high/low, Y-high/low, Z-high/low,</span></div><div class="line">   <span class="comment">//                       magnetometerStatus, X-high/low, Y-high/low, Z-high/low)</span></div><div class="line">   i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#abdceaaac3c61e61fe60a08bbd1fd4666">txRx</a>(DEVICE_ADDRESS, 1, <span class="keyword">sizeof</span>(dataXYZ), dataXYZ);</div><div class="line">   data.accelerometerStatus = dataXYZ[0];</div><div class="line">   data.accelerometer_X     = ((dataXYZ[1]&lt;&lt;8)+dataXYZ[2]);</div><div class="line">   data.accelerometer_Y     = ((dataXYZ[3]&lt;&lt;8)+dataXYZ[4]);</div><div class="line">   data.accelerometer_Z     = ((dataXYZ[5]&lt;&lt;8)+dataXYZ[6]);</div><div class="line">   data.magnetometerStatus = dataXYZ[7];</div><div class="line">   data.magnetometer_X      = ((dataXYZ[7]&lt;&lt;8)+dataXYZ[8]);</div><div class="line">   data.magnetometer_Y      = ((dataXYZ[9]&lt;&lt;8)+dataXYZ[10]);</div><div class="line">   data.magnetometer_Z      = ((dataXYZ[10]&lt;&lt;8)+dataXYZ[11]);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/*!</span></div><div class="line"><span class="comment"> * Read ID from accelerometer</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return ID value as 8-bit number (0x1A for MMA8451Q)</span></div><div class="line"><span class="comment"> */</span></div><div class="line">uint32_t FXOS8700CQ::readID(<span class="keywordtype">void</span>) {</div><div class="line">   uint8_t values[] = {WHO_AM_I};</div><div class="line">   i2c.<a class="code" href="class_u_s_b_d_m_1_1_i2c.html#abdceaaac3c61e61fe60a08bbd1fd4666">txRx</a>(DEVICE_ADDRESS, 1, <span class="keyword">sizeof</span>(values), values);</div><div class="line">   <span class="keywordflow">return</span> values[0];</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Calibrate accelerometer</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::calibrateAccelerometer() {</div><div class="line"></div><div class="line">   uint8_t originalControlReg1Value = readReg(CTRL_REG1);</div><div class="line">   uint8_t originalXYXDataConfigValue = readReg(XYZ_DATA_CFG);</div><div class="line"></div><div class="line">   <span class="comment">// Make inactive so setting can be modified</span></div><div class="line">   writeReg(CTRL_REG1, 0x00);</div><div class="line"></div><div class="line">   <span class="comment">// Clear existing offsets</span></div><div class="line">   writeReg(OFF_X, 0);</div><div class="line">   writeReg(OFF_Y, 0);</div><div class="line">   writeReg(OFF_Z, 0);</div><div class="line"></div><div class="line">   <span class="keywordtype">int</span> mode = (originalXYXDataConfigValue&amp;FXOS8700CQ_XYZ_DATA_CFG_FS_MASK)&gt;&gt;FXOS8700CQ_XYZ_DATA_CFG_FS_OFF;</div><div class="line"></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> calibration2Gs[]     = {4096*8, 2048*8, 1024*8};</div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> calibrationFactors[] = {8*8, 4*8, 2*8};</div><div class="line"></div><div class="line">   <span class="keywordtype">int</span> calibration2G     = calibration2Gs[mode];</div><div class="line">   <span class="keywordtype">int</span> calibrationFactor = calibrationFactors[mode];</div><div class="line"></div><div class="line">   writeReg(CTRL_REG1,</div><div class="line">         FXOS8700CQ_CTRL_REG1_ASLP_RATE(0) | <span class="comment">/* 50 Hz auto-sleep rate */</span></div><div class="line">         FXOS8700CQ_CTRL_REG1_DR(2) |        <span class="comment">/* 200 Hz update rate    */</span></div><div class="line">         FXOS8700CQ_CTRL_REG1_ACTIVE_MASK);  <span class="comment">/* Active     */</span></div><div class="line"></div><div class="line">   int16_t Xout_Accel_14_bit, Yout_Accel_14_bit, Zout_Accel_14_bit;</div><div class="line">   <span class="keywordtype">int</span>     Xout_Accel=0, Yout_Accel=0, Zout_Accel=0;</div><div class="line"></div><div class="line">   <span class="comment">// Average 8 samples to reduce noise</span></div><div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;8; i++) {</div><div class="line">      <span class="keywordtype">int</span> status;</div><div class="line">      <span class="keywordflow">do</span> {</div><div class="line">         readAccelerometerXYZ(&amp;status, &amp;Xout_Accel_14_bit, &amp;Yout_Accel_14_bit, &amp;Zout_Accel_14_bit);</div><div class="line">      } <span class="keywordflow">while</span> ((status &amp; FXOS8700CQ_STATUS_XYZDR_MASK) == 0);</div><div class="line">      Xout_Accel += Xout_Accel_14_bit;</div><div class="line">      Yout_Accel += Yout_Accel_14_bit;</div><div class="line">      Zout_Accel += Zout_Accel_14_bit;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="comment">// Make inactive so setting can be modified</span></div><div class="line">   writeReg(CTRL_REG1, 0x00);</div><div class="line"></div><div class="line">   <span class="keywordtype">char</span> X_Accel_offset = -(Xout_Accel / calibrationFactor);                    <span class="comment">// Compute X-axis offset correction value</span></div><div class="line">   <span class="keywordtype">char</span> Y_Accel_offset = -(Yout_Accel / calibrationFactor);                    <span class="comment">// Compute Y-axis offset correction value</span></div><div class="line">   <span class="keywordtype">char</span> Z_Accel_offset = -((Zout_Accel - calibration2G) / calibrationFactor);  <span class="comment">// Compute Z-axis offset correction value</span></div><div class="line"></div><div class="line">   writeReg(OFF_X, X_Accel_offset);</div><div class="line">   writeReg(OFF_Y, Y_Accel_offset);</div><div class="line">   writeReg(OFF_Z, Z_Accel_offset);</div><div class="line"></div><div class="line">   <span class="comment">// Restore original settings</span></div><div class="line">   writeReg(CTRL_REG1, originalControlReg1Value);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Simple calibration of magnetometer</span></div><div class="line"><span class="comment"> * Requires user to rotate the board in all dimensions</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param time How long to run calibration in seconds</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> FXOS8700CQ::calibrateMagnetometer(<span class="keywordtype">int</span> time) {</div><div class="line"></div><div class="line">   uint8_t originalMControlReg1Value = readReg(M_CTRL_REG1);</div><div class="line">   uint8_t originalControlReg1Value  = readReg(CTRL_REG1);</div><div class="line"></div><div class="line"><span class="comment">//   uint8_t buff[6] = {M_OFF_X_MSB};</span></div><div class="line"><span class="comment">//   i2c.txRx(DEVICE_ADDRESS, buff, 1, sizeof(buff));</span></div><div class="line"><span class="comment">//   printf(&quot;FXOS8700CQ, m_offset = 0x%02x%02x, 0x%02x%02x, 0x%02x%02x,\n&quot;, buff[0], buff[1], buff[2], buff[3], buff[4], buff[5] );</span></div><div class="line"></div><div class="line">   <span class="comment">// Make inactive so setting can be changed</span></div><div class="line">   writeReg(CTRL_REG1, 0x00);</div><div class="line">   writeReg(CTRL_REG1,</div><div class="line">         FXOS8700CQ_CTRL_REG1_ASLP_RATE(0) | <span class="comment">// 50 Hz auto-sleep rate</span></div><div class="line">         FXOS8700CQ_CTRL_REG1_DR(6) |        <span class="comment">// 6.25 Hz update rate (assuming mag only)</span></div><div class="line">         FXOS8700CQ_CTRL_REG1_ACTIVE_MASK);  <span class="comment">// Active</span></div><div class="line">   writeReg(M_CTRL_REG1,</div><div class="line">         FXOS8700CQ_M_CTRL_REG1_M_ACAL_MASK|       <span class="comment">// Magnetic hard-iron offset auto-calibration enabled</span></div><div class="line">         FXOS8700CQ_M_CTRL_REG1_M_OS(7)|           <span class="comment">// Maximum over-sample</span></div><div class="line">         FXOS8700CQ_M_CTRL_REG1_M_HMS(MAG_ONLY));  <span class="comment">// Magnetometer only</span></div><div class="line"></div><div class="line">   <span class="comment">// Samples @ 6.35 Hz</span></div><div class="line">   <a name="a4"></a><a class="code" href="namespace_u_s_b_d_m.html#ad4b50dfe4106221f5205e2b2137cb492">waitMS</a>(time*1000);</div><div class="line"></div><div class="line"><span class="comment">//   buff[0] = M_OFF_X_MSB;</span></div><div class="line"><span class="comment">//   i2c.txRx(DEVICE_ADDRESS, buff, 1, sizeof(buff));</span></div><div class="line"><span class="comment">//   printf(&quot;FXOS8700CQ, m_offset = 0x%02x%02x, 0x%02x%02x, 0x%02x%02x,\n&quot;, buff[0], buff[1], buff[2], buff[3], buff[4], buff[5] );</span></div><div class="line"></div><div class="line">   <span class="comment">// Make inactive so setting can be changed</span></div><div class="line">   writeReg(CTRL_REG1, 0x00);</div><div class="line">   <span class="comment">// Restore original settings</span></div><div class="line">   writeReg(M_CTRL_REG1, originalMControlReg1Value);</div><div class="line">   writeReg(CTRL_REG1, originalControlReg1Value);</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Aug 21 2017 07:45:21 for USBDM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
