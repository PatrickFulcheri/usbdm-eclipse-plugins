<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USBDM: usb_implementation_composite.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USBDM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">usb_implementation_composite.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @file     usb_implementation_composite.cpp</span></div><div class="line"><span class="comment"> * @brief    USB Composite device implementation</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This module provides an implementation of a USB Composite interface</span></div><div class="line"><span class="comment"> * including the following end points:</span></div><div class="line"><span class="comment"> *  - EP0 Standard control</span></div><div class="line"><span class="comment"> *  - EP1 Bulk OUT</span></div><div class="line"><span class="comment"> *  - EP2 Bulk IN</span></div><div class="line"><span class="comment"> *  - EP3 Interrupt CDC notification</span></div><div class="line"><span class="comment"> *  - EP4 CDC data OUT</span></div><div class="line"><span class="comment"> *  - EP5 CDC data IN</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @version  V4.12.1.170</span></div><div class="line"><span class="comment"> * @date     2 April 2017</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  This file provides the implementation specific code for the USB interface.</span></div><div class="line"><span class="comment"> *  It will need to be modified to suit an application.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="usb_8h.html">usb.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;usb_implementation_composite.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespace_u_s_b_d_m.html">USBDM</a> {</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Interface numbers for USB descriptors</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">enum</span> InterfaceNumbers {<span class="comment"></span></div><div class="line"><span class="comment">   /** Interface number for BDM channel */</span></div><div class="line">   BULK_INTF_ID,</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /** Interface number for CDC Control channel */</span></div><div class="line">   CDC_COMM_INTF_ID,<span class="comment"></span></div><div class="line"><span class="comment">   /** Interface number for CDC Data channel */</span></div><div class="line">   CDC_DATA_INTF_ID,</div><div class="line">   <span class="comment">/*</span></div><div class="line"><span class="comment">    * TODO Add additional Interface numbers here</span></div><div class="line"><span class="comment">    */</span><span class="comment"></span></div><div class="line"><span class="comment">   /** Total number of interfaces */</span></div><div class="line">   NUMBER_OF_INTERFACES,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * String descriptors</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_language[]        = {4, <a name="a0"></a><a class="code" href="usb__defs_8h.html#a8513ab325267ccde08483478c67eecf2">DT_STRING</a>, 0x09, 0x0C};  <span class="comment">//!&lt; Language IDs</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_manufacturer[]    = MANUFACTURER;                <span class="comment">//!&lt; Manufacturer</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_product[]         = PRODUCT_DESCRIPTION;         <span class="comment">//!&lt; Product Description</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_serial[]          = SERIAL_NO;                   <span class="comment">//!&lt; Serial Number</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_config[]          = <span class="stringliteral">&quot;Default configuration&quot;</span>;     <span class="comment">//!&lt; Configuration name</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_bulk_interface[]  = <span class="stringliteral">&quot;Bulk Interface&quot;</span>;           <span class="comment">//!&lt; Bulk Interface</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_cdc_interface[]   = <span class="stringliteral">&quot;CDC Interface&quot;</span>;             <span class="comment">//!&lt; Interface Association #2</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_cdc_control[]     = <span class="stringliteral">&quot;CDC Control Interface&quot;</span>;     <span class="comment">//!&lt; CDC Control Interface</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_cdc_data[]        = <span class="stringliteral">&quot;CDC Data Interface&quot;</span>;        <span class="comment">//!&lt; CDC Data Interface</span></div><div class="line"><span class="comment"></span><span class="comment">/*</span></div><div class="line"><span class="comment"> * Add additional String descriptors here</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * String descriptor table</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">const</span> uint8_t *<span class="keyword">const</span> Usb0::stringDescriptors[] = {</div><div class="line">      s_language,</div><div class="line">      s_manufacturer,</div><div class="line">      s_product,</div><div class="line">      s_serial,</div><div class="line">      s_config,</div><div class="line"></div><div class="line">      s_bulk_interface,</div><div class="line">      </div><div class="line">      s_cdc_interface,</div><div class="line">      s_cdc_control,</div><div class="line">      s_cdc_data</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * Add additional String descriptors here</span></div><div class="line"><span class="comment">       */</span></div><div class="line">};</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Device Descriptor</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">const</span> <a name="_a1"></a><a class="code" href="struct_device_descriptor.html">DeviceDescriptor</a> Usb0::deviceDescriptor = {</div><div class="line">      <span class="comment">/* bLength             */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_device_descriptor.html">DeviceDescriptor</a>),</div><div class="line">      <span class="comment">/* bDescriptorType     */</span> <a name="a2"></a><a class="code" href="usb__defs_8h.html#ad861bac4989969ee4eb308675bca273e">DT_DEVICE</a>,</div><div class="line">      <span class="comment">/* bcdUSB              */</span> <a name="a3"></a><a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(0x0200),           <span class="comment">// USB specification release No. [BCD = 2.00]</span></div><div class="line">      <span class="comment">/* bDeviceClass        */</span> 0xEF,                    <span class="comment">// Device Class code [Miscellaneous Device Class]</span></div><div class="line">      <span class="comment">/* bDeviceSubClass     */</span> 0x02,                    <span class="comment">// Sub Class code    [Common Class]</span></div><div class="line">      <span class="comment">/* bDeviceProtocol     */</span> 0x01,                    <span class="comment">// Protocol          [Interface Association Descriptor]</span></div><div class="line">      <span class="comment">/* bMaxPacketSize0     */</span> CONTROL_EP_MAXSIZE,             <span class="comment">// EndPt 0 max packet size</span></div><div class="line">      <span class="comment">/* idVendor            */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(VENDOR_ID),        <span class="comment">// Vendor ID</span></div><div class="line">      <span class="comment">/* idProduct           */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(PRODUCT_ID),       <span class="comment">// Product ID</span></div><div class="line">      <span class="comment">/* bcdDevice           */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(VERSION_ID),       <span class="comment">// Device Release    [BCD = 4.10]</span></div><div class="line">      <span class="comment">/* iManufacturer       */</span> s_manufacturer_index,           <span class="comment">// String index of Manufacturer name</span></div><div class="line">      <span class="comment">/* iProduct            */</span> s_product_index,                <span class="comment">// String index of product description</span></div><div class="line">      <span class="comment">/* iSerialNumber       */</span> s_serial_index,                 <span class="comment">// String index of serial number</span></div><div class="line">      <span class="comment">/* bNumConfigurations  */</span> NUMBER_OF_CONFIGURATIONS        <span class="comment">// Number of configurations</span></div><div class="line">};</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * All other descriptors</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">const</span> Usb0::Descriptors Usb0::otherDescriptors = {</div><div class="line">      { <span class="comment">// configDescriptor</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a name="_a4"></a><a class="code" href="struct_configuration_descriptor.html">ConfigurationDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a5"></a><a class="code" href="usb__defs_8h.html#afad7359bec46b3769234776a692bedee">DT_CONFIGURATION</a>,</div><div class="line">            <span class="comment">/* wTotalLength            */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(<span class="keyword">sizeof</span>(otherDescriptors)),</div><div class="line">            <span class="comment">/* bNumInterfaces          */</span> NUMBER_OF_INTERFACES,</div><div class="line">            <span class="comment">/* bConfigurationValue     */</span> CONFIGURATION_NUM,</div><div class="line">            <span class="comment">/* iConfiguration          */</span> s_config_index,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> 0x80,     <span class="comment">//  = Bus powered, no wake-up</span></div><div class="line">            <span class="comment">/* bMaxPower               */</span> <a name="a6"></a><a class="code" href="usb__defs_8h.html#a403c0219269482c444d915b70302d0be">USBMilliamps</a>(500)</div><div class="line">      },<span class="comment"></span></div><div class="line"><span class="comment">      /**</span></div><div class="line"><span class="comment">       * Bulk interface, 2 end-points</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      { <span class="comment">// bulk_interface</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a name="_a7"></a><a class="code" href="struct_interface_descriptor.html">InterfaceDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a8"></a><a class="code" href="usb__defs_8h.html#a17dcdee8992117f57b17f45b329000bf">DT_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bInterfaceNumber        */</span> BULK_INTF_ID,</div><div class="line">            <span class="comment">/* bAlternateSetting       */</span> 0,</div><div class="line">            <span class="comment">/* bNumEndpoints           */</span> 2,</div><div class="line">            <span class="comment">/* bInterfaceClass         */</span> 0xFF,                         <span class="comment">// (Vendor specific)</span></div><div class="line">            <span class="comment">/* bInterfaceSubClass      */</span> 0xFF,                         <span class="comment">// (Vendor specific)</span></div><div class="line">            <span class="comment">/* bInterfaceProtocol      */</span> 0xFF,                         <span class="comment">// (Vendor specific)</span></div><div class="line">            <span class="comment">/* iInterface desc         */</span> s_bulk_interface_index,</div><div class="line">      },</div><div class="line">      { <span class="comment">// bulk_out_endpoint - OUT, Bulk</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a name="_a9"></a><a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a10"></a><a class="code" href="usb__defs_8h.html#a6867b42d6d9fb2e02fa34e5900201aad">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a name="a11"></a><a class="code" href="usb__defs_8h.html#ae33c78feb670de33d2abf21ec0624531a09451b411e1b9e3da67123d0bec0b421">EP_OUT</a>|BULK_OUT_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a name="a12"></a><a class="code" href="usb__defs_8h.html#a56161d6bedecf83b37aadfc4dec35432">ATTR_BULK</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(BULK_OUT_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a name="a13"></a><a class="code" href="usb__defs_8h.html#a683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(1)</div><div class="line">      },</div><div class="line">      { <span class="comment">// bulk_in_endpoint - IN, Bulk</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="usb__defs_8h.html#a6867b42d6d9fb2e02fa34e5900201aad">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a name="a14"></a><a class="code" href="usb__defs_8h.html#ae33c78feb670de33d2abf21ec0624531a4baa33e30d47dfc6f9406f98fc906456">EP_IN</a>|BULK_IN_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a class="code" href="usb__defs_8h.html#a56161d6bedecf83b37aadfc4dec35432">ATTR_BULK</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(BULK_IN_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a class="code" href="usb__defs_8h.html#a683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(1)</div><div class="line">      },</div><div class="line">      { <span class="comment">// interfaceAssociationDescriptorCDC</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a name="_a15"></a><a class="code" href="struct_interface_association_descriptor.html">InterfaceAssociationDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a16"></a><a class="code" href="usb__defs_8h.html#a8d051b504fcdf7ff7fd0a7f7c8591639">DT_INTERFACEASSOCIATION</a>,</div><div class="line">            <span class="comment">/* bFirstInterface         */</span> CDC_COMM_INTF_ID,</div><div class="line">            <span class="comment">/* bInterfaceCount         */</span> 2,</div><div class="line">            <span class="comment">/* bFunctionClass          */</span> 0x02,                                   <span class="comment">//  CDC Control</span></div><div class="line">            <span class="comment">/* bFunctionSubClass       */</span> 0x02,                                   <span class="comment">//  Abstract Control Model</span></div><div class="line">            <span class="comment">/* bFunctionProtocol       */</span> 0x01,                                   <span class="comment">//  AT CommandL V.250</span></div><div class="line">            <span class="comment">/* iFunction = &quot;&quot;          */</span> s_cdc_interface_index,</div><div class="line">      },<span class="comment"></span></div><div class="line"><span class="comment">      /**</span></div><div class="line"><span class="comment">       * CDC Control/Communication Interface, 1 end-point</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      { <span class="comment">// cdc_CCI_Interface</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_interface_descriptor.html">InterfaceDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="usb__defs_8h.html#a17dcdee8992117f57b17f45b329000bf">DT_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bInterfaceNumber        */</span> CDC_COMM_INTF_ID,</div><div class="line">            <span class="comment">/* bAlternateSetting       */</span> 0,</div><div class="line">            <span class="comment">/* bNumEndpoints           */</span> 1,</div><div class="line">            <span class="comment">/* bInterfaceClass         */</span> 0x02,      <span class="comment">//  CDC Communication</span></div><div class="line">            <span class="comment">/* bInterfaceSubClass      */</span> 0x02,      <span class="comment">//  Abstract Control Model</span></div><div class="line">            <span class="comment">/* bInterfaceProtocol      */</span> 0x01,      <span class="comment">//  V.25ter, AT Command V.250</span></div><div class="line">            <span class="comment">/* iInterface description  */</span> s_cdc_control_interface_index</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_Functional_Header</span></div><div class="line">            <span class="comment">/* bFunctionalLength       */</span> <span class="keyword">sizeof</span>(<a name="_a17"></a><a class="code" href="struct_c_d_c_header_functional_descriptor.html">CDCHeaderFunctionalDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a18"></a><a class="code" href="usb__defs_8h.html#a104f7f440633d5d270fba57dfa0666d0">CS_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bDescriptorSubtype      */</span> <a name="a19"></a><a class="code" href="usb__defs_8h.html#a42a839b8d9e39bf51aef5b36479b1ed2">DST_HEADER</a>,</div><div class="line">            <span class="comment">/* bcdCDC                  */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(0x0110),</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_CallManagement</span></div><div class="line">            <span class="comment">/* bFunctionalLength       */</span> <span class="keyword">sizeof</span>(<a name="_a20"></a><a class="code" href="struct_c_d_c_call_management_functional_descriptor.html">CDCCallManagementFunctionalDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="usb__defs_8h.html#a104f7f440633d5d270fba57dfa0666d0">CS_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bDescriptorSubtype      */</span> <a name="a21"></a><a class="code" href="usb__defs_8h.html#a56e20b25adaace43513bdc85f0a3e709">DST_CALL_MANAGEMENT</a>,</div><div class="line">            <span class="comment">/* bmCapabilities          */</span> 1,</div><div class="line">            <span class="comment">/* bDataInterface          */</span> CDC_DATA_INTF_ID,</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_Functional_ACM</span></div><div class="line">            <span class="comment">/* bFunctionalLength       */</span> <span class="keyword">sizeof</span>(<a name="_a22"></a><a class="code" href="struct_c_d_c_abstract_control_management_descriptor.html">CDCAbstractControlManagementDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="usb__defs_8h.html#a104f7f440633d5d270fba57dfa0666d0">CS_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bDescriptorSubtype      */</span> <a name="a23"></a><a class="code" href="usb__defs_8h.html#adc08ecc6601ffea46eb02eb2ddda6b50">DST_ABSTRACT_CONTROL_MANAGEMENT</a>,</div><div class="line">            <span class="comment">/* bmCapabilities          */</span> 0x06,</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_Functional_Union</span></div><div class="line">            <span class="comment">/* bFunctionalLength       */</span> <span class="keyword">sizeof</span>(<a name="_a24"></a><a class="code" href="struct_c_d_c_union_functional_descriptor.html">CDCUnionFunctionalDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="usb__defs_8h.html#a104f7f440633d5d270fba57dfa0666d0">CS_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bDescriptorSubtype      */</span> <a name="a25"></a><a class="code" href="usb__defs_8h.html#a37b0be8334ea3077604b08d6b0dfcbc6">DST_UNION_MANAGEMENT</a>,</div><div class="line">            <span class="comment">/* bmControlInterface      */</span> CDC_COMM_INTF_ID,</div><div class="line">            <span class="comment">/* bSubordinateInterface0  */</span> {CDC_DATA_INTF_ID},</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_notification_Endpoint - IN,interrupt</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="usb__defs_8h.html#a6867b42d6d9fb2e02fa34e5900201aad">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a class="code" href="usb__defs_8h.html#ae33c78feb670de33d2abf21ec0624531a4baa33e30d47dfc6f9406f98fc906456">EP_IN</a>|CDC_NOTIFICATION_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a name="a26"></a><a class="code" href="usb__defs_8h.html#aaf8e3e725be9d83152af5c62c8ca003c">ATTR_INTERRUPT</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(CDC_NOTIFICATION_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a class="code" href="usb__defs_8h.html#a683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(255)</div><div class="line">      },<span class="comment"></span></div><div class="line"><span class="comment">      /**</span></div><div class="line"><span class="comment">       * CDC Data Interface, 2 end-points</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      { <span class="comment">// cdc_DCI_Interface</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_interface_descriptor.html">InterfaceDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="usb__defs_8h.html#a17dcdee8992117f57b17f45b329000bf">DT_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bInterfaceNumber        */</span> CDC_DATA_INTF_ID,</div><div class="line">            <span class="comment">/* bAlternateSetting       */</span> 0,</div><div class="line">            <span class="comment">/* bNumEndpoints           */</span> 2,</div><div class="line">            <span class="comment">/* bInterfaceClass         */</span> 0x0A,                         <span class="comment">//  CDC DATA</span></div><div class="line">            <span class="comment">/* bInterfaceSubClass      */</span> 0x00,                         <span class="comment">//  -</span></div><div class="line">            <span class="comment">/* bInterfaceProtocol      */</span> 0x00,                         <span class="comment">//  -</span></div><div class="line">            <span class="comment">/* iInterface description  */</span> s_cdc_data_Interface_index</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_dataOut_Endpoint - OUT, Bulk</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="usb__defs_8h.html#a6867b42d6d9fb2e02fa34e5900201aad">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a class="code" href="usb__defs_8h.html#ae33c78feb670de33d2abf21ec0624531a09451b411e1b9e3da67123d0bec0b421">EP_OUT</a>|CDC_DATA_OUT_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a class="code" href="usb__defs_8h.html#a56161d6bedecf83b37aadfc4dec35432">ATTR_BULK</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(CDC_DATA_OUT_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a class="code" href="usb__defs_8h.html#a683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(1)</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_dataIn_Endpoint - IN, Bulk</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="usb__defs_8h.html#a6867b42d6d9fb2e02fa34e5900201aad">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a class="code" href="usb__defs_8h.html#ae33c78feb670de33d2abf21ec0624531a4baa33e30d47dfc6f9406f98fc906456">EP_IN</a>|CDC_DATA_IN_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a class="code" href="usb__defs_8h.html#a56161d6bedecf83b37aadfc4dec35432">ATTR_BULK</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(CDC_DATA_IN_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a class="code" href="usb__defs_8h.html#a683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(1)</div><div class="line">      },</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * TODO Add additional Descriptors here</span></div><div class="line"><span class="comment">       */</span></div><div class="line">};</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** Out end-point for BULK data out */</span></div><div class="line">OutEndpoint &lt;Usb0Info, Usb0::BULK_OUT_ENDPOINT, BULK_OUT_EP_MAXSIZE&gt; Usb0::epBulkOut;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** In end-point for BULK data in */</span></div><div class="line">InEndpoint  &lt;Usb0Info, Usb0::BULK_IN_ENDPOINT,  BULK_IN_EP_MAXSIZE&gt;  Usb0::epBulkIn;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** In end-point for CDC notifications */</span></div><div class="line">InEndpoint  &lt;Usb0Info, Usb0::CDC_NOTIFICATION_ENDPOINT, CDC_NOTIFICATION_EP_MAXSIZE&gt;  Usb0::epCdcNotification;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** Out end-point for CDC data out */</span></div><div class="line">OutEndpoint &lt;Usb0Info, Usb0::CDC_DATA_OUT_ENDPOINT,     CDC_DATA_OUT_EP_MAXSIZE&gt;      Usb0::epCdcDataOut;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** In end-point for CDC data in */</span></div><div class="line">InEndpoint  &lt;Usb0Info, Usb0::CDC_DATA_IN_ENDPOINT,      CDC_DATA_IN_EP_MAXSIZE&gt;       Usb0::epCdcDataIn;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * TODO Add additional end-points here</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Handler for Start of Frame Token interrupt (~1ms interval)</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::sofCallback() {</div><div class="line">   <span class="comment">// Activity LED</span></div><div class="line">   <span class="comment">// Off                     - no USB activity, not connected</span></div><div class="line">   <span class="comment">// On                      - no USB activity, connected</span></div><div class="line">   <span class="comment">// Off, flash briefly on   - USB activity, not connected</span></div><div class="line">   <span class="comment">// On,  flash briefly off  - USB activity, connected</span></div><div class="line">   <span class="keywordflow">if</span> (usb-&gt;FRMNUML==0) { <span class="comment">// Every ~256 ms</span></div><div class="line">      <span class="keywordflow">switch</span> (usb-&gt;FRMNUMH&amp;0x03) {</div><div class="line">         <span class="keywordflow">case</span> 0:</div><div class="line">            <span class="keywordflow">if</span> (connectionState == <a name="a27"></a><a class="code" href="usb__defs_8h.html#aeb8d203c6d5c384d6c4db8cc9d4da235a896a9b9aaec9f4e588064fb13d8de4c5">USBconfigured</a>) {</div><div class="line">               <span class="comment">// Activity LED on when USB connection established</span></div><div class="line"><span class="comment">//               UsbLed::on();</span></div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span> {</div><div class="line">               <span class="comment">// Activity LED off when no USB connection</span></div><div class="line"><span class="comment">//               UsbLed::off();</span></div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         <span class="keywordflow">case</span> 1:</div><div class="line">         <span class="keywordflow">case</span> 2:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         <span class="keywordflow">case</span> 3:</div><div class="line">         default :</div><div class="line">            <span class="keywordflow">if</span> (activityFlag) {</div><div class="line">               <span class="comment">// Activity LED flashes</span></div><div class="line"><span class="comment">//               UsbLed::toggle();</span></div><div class="line">               setActive(<span class="keyword">false</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="comment">// Check CDC status</span></div><div class="line">   epCdcSendNotification();</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Configure epCdcNotification for an IN status transaction [Tx, device -&gt; host, DATA0/1]\n</span></div><div class="line"><span class="comment"> * A packet is only sent if there has been a change in status</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::epCdcSendNotification() {</div><div class="line">   <span class="keyword">const</span> <a name="_a28"></a><a class="code" href="struct_c_d_c_notification.html">CDCNotification</a> cdcNotification= {<a name="a29"></a><a class="code" href="usb__defs_8h.html#a219a2d18e82dc6245cc8b1aa12c6377f">CDC_NOTIFICATION</a>, <a name="a30"></a><a class="code" href="usb__defs_8h.html#a8e278dbd137d5d873d24e1647be9d4e6">SERIAL_STATE</a>, 0, <a name="a31"></a><a class="code" href="usb__defs_8h.html#a9eddb8dd2bb93652af10997713015eab">RT_INTERFACE</a>, <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(2)};</div><div class="line">   <span class="keyword">static</span> uint8_t lastStatus = -1;</div><div class="line">   uint8_t status = cdcInterface::getSerialState().bits;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (status == lastStatus) {</div><div class="line">      <span class="comment">// No change</span></div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (epCdcNotification.getState() != <a name="a32"></a><a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) {</div><div class="line">      <span class="comment">// Busy with previous</span></div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line">   static_assert(epCdcNotification.BUFFER_SIZE&gt;=<span class="keyword">sizeof</span>(<a class="code" href="struct_c_d_c_notification.html">CDCNotification</a>), <span class="stringliteral">&quot;Buffer size insufficient&quot;</span>);</div><div class="line"></div><div class="line">   lastStatus = status;</div><div class="line"></div><div class="line">   <span class="comment">// Copy the data to Tx buffer</span></div><div class="line">   (void)memcpy(epCdcNotification.getBuffer(), &amp;cdcNotification, <span class="keyword">sizeof</span>(cdcNotification));</div><div class="line">   epCdcNotification.getBuffer()[<span class="keyword">sizeof</span>(cdcNotification)+0] = status;</div><div class="line">   epCdcNotification.getBuffer()[<span class="keyword">sizeof</span>(cdcNotification)+1] = 0;</div><div class="line"></div><div class="line">   <span class="comment">// Set up to Tx packet</span></div><div class="line"><span class="comment">//   PRINTF(&quot;epCdcSendNotification(0x%2X)\n&quot;, epCdcNotification.getBuffer()[sizeof(cdcNotification)+0]);</span></div><div class="line">   epCdcNotification.startTxTransaction(<a name="a33"></a><a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>, <span class="keyword">sizeof</span>(cdcNotification)+2);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> uint8_t cdcOutBuff[10] = <span class="stringliteral">&quot;Welcome\n&quot;</span>;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> cdcOutByteCount    = 8;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Start CDC IN transaction\n</span></div><div class="line"><span class="comment"> * A packet is only sent if data is available</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::startCdcIn() {</div><div class="line">   <span class="keywordflow">if</span> ((epCdcDataIn.getState() == <a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) &amp;&amp; (cdcOutByteCount&gt;0)) {</div><div class="line">      static_assert(epCdcDataIn.BUFFER_SIZE&gt;<span class="keyword">sizeof</span>(cdcOutBuff), <span class="stringliteral">&quot;Buffer too small&quot;</span>);</div><div class="line">      memcpy(epCdcDataIn.getBuffer(), cdcOutBuff, cdcOutByteCount);</div><div class="line">      epCdcDataIn.setNeedZLP();</div><div class="line">      epCdcDataIn.startTxTransaction(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>, cdcOutByteCount);</div><div class="line">      cdcOutByteCount = 0;</div><div class="line">   }</div><div class="line">}<span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Handler for Token Complete USB interrupts for</span></div><div class="line"><span class="comment"> * end-points other than EP0</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleTokenComplete() {</div><div class="line"></div><div class="line">   <span class="comment">// Status from Token</span></div><div class="line">   uint8_t   usbStat  = usb-&gt;STAT;</div><div class="line"></div><div class="line">   <span class="comment">// Endpoint number</span></div><div class="line">   uint8_t   endPoint = ((uint8_t)usbStat)&gt;&gt;4;</div><div class="line"></div><div class="line">   endPoints[endPoint]-&gt;flipOddEven(usbStat);</div><div class="line">   <span class="keywordflow">switch</span> (endPoint) {</div><div class="line">      <span class="keywordflow">case</span> BULK_OUT_ENDPOINT: <span class="comment">// Accept OUT token</span></div><div class="line">         setActive();</div><div class="line">         epBulkOut.handleOutToken();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      <span class="keywordflow">case</span> BULK_IN_ENDPOINT: <span class="comment">// Accept IN token</span></div><div class="line">         epBulkIn.handleInToken();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">      <span class="keywordflow">case</span> CDC_NOTIFICATION_ENDPOINT: <span class="comment">// Accept IN token</span></div><div class="line"><span class="comment">//         PRINTF(&quot;CDC_NOTIFICATION_ENDPOINT\n&quot;);</span></div><div class="line">         epCdcSendNotification();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      <span class="keywordflow">case</span> CDC_DATA_OUT_ENDPOINT: <span class="comment">// Accept OUT token</span></div><div class="line"><span class="comment">//         PRINTF(&quot;CDC_DATA_OUT_ENDPOINT\n&quot;);</span></div><div class="line">         epCdcDataOut.handleOutToken();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      <span class="keywordflow">case</span> CDC_DATA_IN_ENDPOINT:  <span class="comment">// Accept IN token</span></div><div class="line"><span class="comment">//         PRINTF(&quot;CDC_DATA_IN_ENDPOINT\n&quot;);</span></div><div class="line">         epCdcDataIn.handleInToken();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * TODO Add additional end-point handling here</span></div><div class="line"><span class="comment">       */</span></div><div class="line">   }</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Call-back handling CDC-OUT transaction complete\n</span></div><div class="line"><span class="comment"> * Data received is passed to the cdcInterface</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param state Current end-point state</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::cdcOutTransactionCallback(<a name="a34"></a><a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state) {</div><div class="line">   <span class="comment">//   PRINTF(&quot;cdc_out\n&quot;);</span></div><div class="line">   <span class="keywordflow">if</span> (state == <a name="a35"></a><a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacda0f056f12ece9450fe381e8ea569e2581">EPDataOut</a>) {</div><div class="line">      cdcInterface::putData(epCdcDataOut.getDataTransferredSize(), epCdcDataOut.getBuffer());</div><div class="line">   }</div><div class="line">   <span class="comment">// Set up for next transfer</span></div><div class="line">   epCdcDataOut.startRxTransaction(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacda0f056f12ece9450fe381e8ea569e2581">EPDataOut</a>, epCdcDataOut.BUFFER_SIZE);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Call-back handling CDC-IN transaction complete\n</span></div><div class="line"><span class="comment"> * Checks for data and schedules transfer as necessary\n</span></div><div class="line"><span class="comment"> * Each transfer will have a ZLP as necessary.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param state Current end-point state</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::cdcInTransactionCallback(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state) {</div><div class="line">   <span class="keyword">static</span> uint8_t buffer[20];</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> ((state == <a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>)||(state == <a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>)) {</div><div class="line">      <span class="keywordtype">int</span> size = cdcInterface::getData(<span class="keyword">sizeof</span>(buffer), buffer);</div><div class="line">      <span class="keywordflow">if</span> (size != 0) {</div><div class="line">         <span class="comment">// Schedules transfer</span></div><div class="line">         epCdcDataIn.setNeedZLP();</div><div class="line">         epCdcDataIn.startTxTransaction(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>, size, buffer);</div><div class="line">      }</div><div class="line">   }</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Notify IN (device-&gt;host) endpoint that data is available</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return Not used</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">bool</span> Usb0::notify() {</div><div class="line">   <span class="keywordflow">if</span> (epCdcDataIn.getState() == <a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) {</div><div class="line">      <span class="comment">// Have to restart IN transactions</span></div><div class="line">      cdcInTransactionCallback(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Call-back handling BULK-OUT transaction complete</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param state Current end-point state</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::bulkOutTransactionCallback(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state) {</div><div class="line">   (void)state;</div><div class="line">   <span class="comment">// No actions - End-point is polled</span></div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Call-back handling BULK-IN transaction complete</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param state Current end-point state</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::bulkInTransactionCallback(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state) {</div><div class="line">   (void)state;</div><div class="line">   <span class="comment">// No actions - End-point is polled</span></div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Initialise the USB0 interface</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  @note Assumes clock set up for USB operation (48MHz)</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::initialise() {</div><div class="line">   <a name="a36"></a><a class="code" href="class_u_s_b_d_m_1_1_usb_base___t.html#a15053b03de92469cdc929b52415a761a">UsbBase_T::initialise</a>();</div><div class="line"></div><div class="line">   <span class="comment">// Add extra handling of CDC packets directed to EP0</span></div><div class="line">   setUnhandledSetupCallback(handleUserEp0SetupRequests);</div><div class="line"></div><div class="line">   setSOFCallback(sofCallback);</div><div class="line"></div><div class="line">   cdcInterface::initialise();</div><div class="line">   cdcInterface::setUsbInNotifyCallback(notify);</div><div class="line">   <span class="comment">/*</span></div><div class="line"><span class="comment">    * TODO Additional initialisation</span></div><div class="line"><span class="comment">    */</span></div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  Blocking reception of data over bulk OUT end-point</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   @param maxSize  = max # of bytes to receive</span></div><div class="line"><span class="comment"> *   @param buffer   = ptr to buffer for bytes received</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   @return Number of bytes received</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   @note Doesn&#39;t return until command has been received.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> Usb0::receiveBulkData(uint8_t maxSize, uint8_t *buffer) {</div><div class="line">   epBulkOut.startRxTransaction(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacda0f056f12ece9450fe381e8ea569e2581">EPDataOut</a>, maxSize, buffer);</div><div class="line">   <span class="keywordflow">while</span>(epBulkOut.getState() != <a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) {</div><div class="line">      <a name="a37"></a><a class="code" href="group___c_m_s_i_s___core___instruction_interface.html#ga8a55dfb43484b3ed4d181761f92cc2db">__WFI</a>();</div><div class="line">   }</div><div class="line">   setActive();</div><div class="line">   <span class="keywordflow">return</span> epBulkOut.getDataTransferredSize();</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  Blocking transmission of data over bulk IN end-point</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  @param size   Number of bytes to send</span></div><div class="line"><span class="comment"> *  @param buffer Pointer to bytes to send</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   @note : Waits for idle BEFORE transmission but\n</span></div><div class="line"><span class="comment"> *   returns before data has been transmitted</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::sendBulkData(uint8_t size, <span class="keyword">const</span> uint8_t *buffer) {</div><div class="line"><span class="comment">//   commandBusyFlag = false;</span></div><div class="line">   <span class="comment">//   enableUSBIrq();</span></div><div class="line">   <span class="keywordflow">while</span> (epBulkIn.getState() != <a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) {</div><div class="line">      <a class="code" href="group___c_m_s_i_s___core___instruction_interface.html#ga8a55dfb43484b3ed4d181761f92cc2db">__WFI</a>();</div><div class="line">   }</div><div class="line">   epBulkIn.startTxTransaction(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>, size, buffer);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CDC Set line coding handler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleSetLineCoding() {</div><div class="line"><span class="comment">//   PRINTF(&quot;handleSetLineCoding()\n&quot;);</span></div><div class="line">   <span class="keyword">static</span> <a name="_a38"></a><a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a> lineCoding;</div><div class="line"></div><div class="line">   <span class="comment">// Call-back to do after transaction complete</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">auto</span> callback = []() {</div><div class="line">      <span class="comment">// The controlEndpoint buffer will contain the LineCodingStructure data at call-back time</span></div><div class="line">      cdcInterface::setLineCoding(&amp;lineCoding);</div><div class="line">      setSetupCompleteCallback(<span class="keyword">nullptr</span>);</div><div class="line">   };</div><div class="line">   setSetupCompleteCallback(callback);</div><div class="line"></div><div class="line">   <span class="comment">// Don&#39;t use external buffer - this requires response to fit in internal EP buffer</span></div><div class="line">   static_assert(<span class="keyword">sizeof</span>(<a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a>) &lt; controlEndpoint.BUFFER_SIZE, <span class="stringliteral">&quot;Buffer insufficient size&quot;</span>);</div><div class="line">   controlEndpoint.startRxTransaction(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacda0f056f12ece9450fe381e8ea569e2581">EPDataOut</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a>), (uint8_t*)&amp;lineCoding);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CDC Get line coding handler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleGetLineCoding() {</div><div class="line"><span class="comment">//   PRINTF(&quot;handleGetLineCoding()\n&quot;);</span></div><div class="line">   <span class="comment">// Send packet</span></div><div class="line">   ep0StartTxTransaction( <span class="keyword">sizeof</span>(<a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a>), (<span class="keyword">const</span> uint8_t*)cdcInterface::getLineCoding());</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CDC Set line state handler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleSetControlLineState() {</div><div class="line"><span class="comment">//   PRINTF(&quot;handleSetControlLineState(%X)\n&quot;, ep0SetupBuffer.wValue.lo());</span></div><div class="line">   cdcInterface::setControlLineState(ep0SetupBuffer.wValue.lo());</div><div class="line">   <span class="comment">// Tx empty Status packet</span></div><div class="line">   ep0StartTxTransaction( 0, <span class="keyword">nullptr</span> );</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CDC Send break handler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleSendBreak() {</div><div class="line"><span class="comment">//   PRINTF(&quot;handleSendBreak()\n&quot;);</span></div><div class="line">   cdcInterface::sendBreak(ep0SetupBuffer.wValue);</div><div class="line">   <span class="comment">// Tx empty Status packet</span></div><div class="line">   ep0StartTxTransaction( 0, <span class="keyword">nullptr</span> );</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Handle SETUP requests not handled by base handler</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param setup SETUP packet received from host</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @note Provides CDC extensions</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleUserEp0SetupRequests(<span class="keyword">const</span> <a name="_a39"></a><a class="code" href="struct_setup_packet.html">SetupPacket</a> &amp;setup) {</div><div class="line">   <span class="comment">//PRINTF(&quot;handleUserEp0SetupRequests()\n&quot;);</span></div><div class="line">   <span class="keywordflow">switch</span>(<a name="a40"></a><a class="code" href="usb__defs_8h.html#aabfb6710dfd8429cfb2c61eb3bd84a80">REQ_TYPE</a>(setup.<a name="a41"></a><a class="code" href="struct_setup_packet.html#a5cdaae68cef911cbf007d99765049eac">bmRequestType</a>)) {</div><div class="line">      <span class="keywordflow">case</span> <a name="a42"></a><a class="code" href="usb__defs_8h.html#a4c03b4a32de544ea33ddfe994a3e3ed3">REQ_TYPE_CLASS</a> :</div><div class="line">         <span class="comment">// Class requests</span></div><div class="line">         <span class="keywordflow">switch</span> (setup.<a name="a43"></a><a class="code" href="struct_setup_packet.html#ad842507438aaa73071063de510f3411f">bRequest</a>) {</div><div class="line">            <span class="keywordflow">case</span> <a name="a44"></a><a class="code" href="usb__defs_8h.html#a91a9c047339a1a5918b6a923af6d1af6">SET_LINE_CODING</a> :       handleSetLineCoding();       <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <a name="a45"></a><a class="code" href="usb__defs_8h.html#a6698d8d2ca56fafdc943aec2cede1daf">GET_LINE_CODING</a> :       handleGetLineCoding();       <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <a name="a46"></a><a class="code" href="usb__defs_8h.html#a437869c339749d5d011060cd5676659e">SET_CONTROL_LINE_STATE</a>: handleSetControlLineState(); <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <a name="a47"></a><a class="code" href="usb__defs_8h.html#ab22359d3d41b78ab1a9e634772b1ffbb">SEND_BREAK</a>:             handleSendBreak();           <span class="keywordflow">break</span>;</div><div class="line">            default :                    controlEndpoint.stall();     <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">         controlEndpoint.stall();</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">   }</div><div class="line">}</div><div class="line"></div><div class="line">} <span class="comment">// End namespace USBDM</span></div><div class="line"></div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Aug 21 2017 07:45:21 for USBDM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
